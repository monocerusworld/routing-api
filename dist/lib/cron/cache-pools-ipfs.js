import pinataSDK from '@pinata/sdk';
import { ID_TO_NETWORK_NAME } from '@tartz-one/smart-order-router';
import { Route53, STS } from 'aws-sdk';
import { default as bunyan } from 'bunyan';
import fs from 'fs';
import _ from 'lodash';
import path from 'path';
import { chainProtocols } from './cache-config';
const PARENT = '/tmp/temp/';
const DIRECTORY = '/tmp/temp/v1/pools/';
const pinata = pinataSDK(process.env.PINATA_API_KEY, process.env.PINATA_API_SECRET);
const handler = async (event) => {
    var _a, _b, _c;
    const log = bunyan.createLogger({
        name: 'IPFSPoolCacheLambda',
        serializers: bunyan.stdSerializers,
        level: 'info',
        requestId: event.id,
    });
    const sts = new STS();
    const stsParams = {
        RoleArn: process.env.ROLE_ARN,
        RoleSessionName: `UpdateApiRoute53Role`,
    };
    // init route53 with credentials
    let data;
    let route53;
    try {
        data = await sts.assumeRole(stsParams).promise();
    }
    catch (err) {
        log.error({ err }, `Error assuming role`);
        throw err;
    }
    log.info(`Role assumed`);
    try {
        const accessKeyId = (_a = data === null || data === void 0 ? void 0 : data.Credentials) === null || _a === void 0 ? void 0 : _a.AccessKeyId;
        const secretAccess = (_b = data === null || data === void 0 ? void 0 : data.Credentials) === null || _b === void 0 ? void 0 : _b.SecretAccessKey;
        const sessionKey = (_c = data === null || data === void 0 ? void 0 : data.Credentials) === null || _c === void 0 ? void 0 : _c.SessionToken;
        route53 = new Route53({
            credentials: {
                accessKeyId: accessKeyId,
                secretAccessKey: secretAccess,
                sessionToken: sessionKey,
            },
        });
    }
    catch (err) {
        log.error({ err }, 'Route53 not initialized with correct credentials');
        throw err;
    }
    await Promise.all(_.map(chainProtocols, async ({ protocol, chainId, provider }) => {
        const ipfsFilename = `${ID_TO_NETWORK_NAME(chainId)}.json`;
        log.info(`Getting ${protocol} pools for chain ${chainId}`);
        const pools = await provider.getPools();
        log.info(`Got ${pools.length} ${protocol} pools for chain ${chainId}. Will save with filename ${ipfsFilename}`);
        const poolString = JSON.stringify(pools);
        // create directory and file for the chain and protocol
        // e.g: /tmp/temp/v1/pools/v3/mainnet.json
        const parentDirectory = path.join(DIRECTORY, protocol.toLowerCase());
        const fullPath = path.join(DIRECTORY, protocol.toLowerCase(), ipfsFilename);
        fs.mkdirSync(parentDirectory, { recursive: true });
        fs.writeFileSync(fullPath, poolString);
    }));
    // pins everything under '/tmp/` which should include mainnet.txt and rinkeby.txt
    // only have to pin once for all chains
    let result;
    let hash;
    try {
        log.info({ result }, `Pinning to pinata: ${PARENT}`);
        result = await pinata.pinFromFS(PARENT);
        const url = `https://ipfs.io/ipfs/${result.IpfsHash}`;
        hash = result.IpfsHash;
        log.info({ result }, `Successful pinning. IPFS hash: ${hash} and url : ${url}`);
    }
    catch (err) {
        log.error({ err }, 'Error pinning');
        throw err;
    }
    // link resulting hash to DNS
    const domain = process.env.STAGE == 'prod' ? 'api.uniswap.org' : 'beta.api.uniswap.org';
    var params = {
        ChangeBatch: {
            Changes: [
                {
                    Action: 'UPSERT',
                    ResourceRecordSet: {
                        Name: domain,
                        ResourceRecords: [
                            {
                                Value: `\"dnslink=/ipfs/${hash}\"`,
                            },
                        ],
                        TTL: 60,
                        Type: 'TXT',
                    },
                },
            ],
        },
        HostedZoneId: process.env.HOSTED_ZONE,
    };
    try {
        log.info({ params }, `Updating record set`);
        const data = await route53.changeResourceRecordSets(params).promise();
        log.info(`Successful record update: ${data}`);
    }
    catch (err) {
        log.error({ err }, 'Error updating DNS');
        throw err;
    }
};
module.exports = { handler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtcG9vbHMtaXBmcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jcm9uL2NhY2hlLXBvb2xzLWlwZnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFBO0FBQ25DLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLCtCQUErQixDQUFBO0FBRWxFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQ3RDLE9BQU8sRUFBRSxPQUFPLElBQUksTUFBTSxFQUFxQixNQUFNLFFBQVEsQ0FBQTtBQUM3RCxPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUE7QUFDbkIsT0FBTyxDQUFDLE1BQU0sUUFBUSxDQUFBO0FBQ3RCLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQTtBQUN2QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFFL0MsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFBO0FBRTNCLE1BQU0sU0FBUyxHQUFHLHFCQUFxQixDQUFBO0FBRXZDLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFrQixDQUFDLENBQUE7QUFFckYsTUFBTSxPQUFPLEdBQXFCLEtBQUssRUFBRSxLQUFxQyxFQUFFLEVBQUU7O0lBQ2hGLE1BQU0sR0FBRyxHQUFXLE1BQU0sQ0FBQyxZQUFZLENBQUM7UUFDdEMsSUFBSSxFQUFFLHFCQUFxQjtRQUMzQixXQUFXLEVBQUUsTUFBTSxDQUFDLGNBQWM7UUFDbEMsS0FBSyxFQUFFLE1BQU07UUFDYixTQUFTLEVBQUUsS0FBSyxDQUFDLEVBQUU7S0FDcEIsQ0FBQyxDQUFBO0lBRUYsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtJQUNyQixNQUFNLFNBQVMsR0FBRztRQUNoQixPQUFPLEVBQUUsT0FB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LDZCQUE2QixJQUFJLEVBQUUsQ0FBQyxDQUFBO0tBQzlDO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsb0JBQW9CLENBQUMsQ0FBQTtRQUN4QyxNQUFNLEdBQUcsQ0FBQTtLQUNWO0FBQ0gsQ0FBQyxDQUFBO0FBQ0QsTUFBTSxDQUFDLE9BQU8sR0FBRyxFQUFFLE9BQU8sRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBpbmF0YVNESyBmcm9tICdAcGluYXRhL3NkaydcbmltcG9ydCB7IElEX1RPX05FVFdPUktfTkFNRSB9IGZyb20gJ0B0YXJ0ei1vbmUvc21hcnQtb3JkZXItcm91dGVyJ1xuaW1wb3J0IHsgRXZlbnRCcmlkZ2VFdmVudCwgU2NoZWR1bGVkSGFuZGxlciB9IGZyb20gJ2F3cy1sYW1iZGEnXG5pbXBvcnQgeyBSb3V0ZTUzLCBTVFMgfSBmcm9tICdhd3Mtc2RrJ1xuaW1wb3J0IHsgZGVmYXVsdCBhcyBidW55YW4sIGRlZmF1bHQgYXMgTG9nZ2VyIH0gZnJvbSAnYnVueWFuJ1xuaW1wb3J0IGZzIGZyb20gJ2ZzJ1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCB7IGNoYWluUHJvdG9jb2xzIH0gZnJvbSAnLi9jYWNoZS1jb25maWcnXG5cbmNvbnN0IFBBUkVOVCA9ICcvdG1wL3RlbXAvJ1xuXG5jb25zdCBESVJFQ1RPUlkgPSAnL3RtcC90ZW1wL3YxL3Bvb2xzLydcblxuY29uc3QgcGluYXRhID0gcGluYXRhU0RLKHByb2Nlc3MuZW52LlBJTkFUQV9BUElfS0VZISwgcHJvY2Vzcy5lbnYuUElOQVRBX0FQSV9TRUNSRVQhKVxuXG5jb25zdCBoYW5kbGVyOiBTY2hlZHVsZWRIYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBFdmVudEJyaWRnZUV2ZW50PHN0cmluZywgdm9pZD4pID0+IHtcbiAgY29uc3QgbG9nOiBMb2dnZXIgPSBidW55YW4uY3JlYXRlTG9nZ2VyKHtcbiAgICBuYW1lOiAnSVBGU1Bvb2xDYWNoZUxhbWJkYScsXG4gICAgc2VyaWFsaXplcnM6IGJ1bnlhbi5zdGRTZXJpYWxpemVycyxcbiAgICBsZXZlbDogJ2luZm8nLFxuICAgIHJlcXVlc3RJZDogZXZlbnQuaWQsXG4gIH0pXG5cbiAgY29uc3Qgc3RzID0gbmV3IFNUUygpXG4gIGNvbnN0IHN0c1BhcmFtcyA9IHtcbiAgICBSb2xlQXJuOiBwcm9jZXNzLmVudi5ST0xFX0FSTiEsXG4gICAgUm9sZVNlc3Npb25OYW1lOiBgVXBkYXRlQXBpUm91dGU1M1JvbGVgLFxuICB9XG5cbiAgLy8gaW5pdCByb3V0ZTUzIHdpdGggY3JlZGVudGlhbHNcbiAgbGV0IGRhdGFcbiAgbGV0IHJvdXRlNTNcbiAgdHJ5IHtcbiAgICBkYXRhID0gYXdhaXQgc3RzLmFzc3VtZVJvbGUoc3RzUGFyYW1zKS5wcm9taXNlKClcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yKHsgZXJyIH0sIGBFcnJvciBhc3N1bWluZyByb2xlYClcbiAgICB0aHJvdyBlcnJcbiAgfVxuXG4gIGxvZy5pbmZvKGBSb2xlIGFzc3VtZWRgKVxuICB0cnkge1xuICAgIGNvbnN0IGFjY2Vzc0tleUlkID0gZGF0YT8uQ3JlZGVudGlhbHM/LkFjY2Vzc0tleUlkXG4gICAgY29uc3Qgc2VjcmV0QWNjZXNzID0gZGF0YT8uQ3JlZGVudGlhbHM/LlNlY3JldEFjY2Vzc0tleVxuICAgIGNvbnN0IHNlc3Npb25LZXkgPSBkYXRhPy5DcmVkZW50aWFscz8uU2Vzc2lvblRva2VuXG4gICAgcm91dGU1MyA9IG5ldyBSb3V0ZTUzKHtcbiAgICAgIGNyZWRlbnRpYWxzOiB7XG4gICAgICAgIGFjY2Vzc0tleUlkOiBhY2Nlc3NLZXlJZCEsXG4gICAgICAgIHNlY3JldEFjY2Vzc0tleTogc2VjcmV0QWNjZXNzISxcbiAgICAgICAgc2Vzc2lvblRva2VuOiBzZXNzaW9uS2V5LFxuICAgICAgfSxcbiAgICB9KVxuICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgIGxvZy5lcnJvcih7IGVyciB9LCAnUm91dGU1MyBub3QgaW5pdGlhbGl6ZWQgd2l0aCBjb3JyZWN0IGNyZWRlbnRpYWxzJylcbiAgICB0aHJvdyBlcnJcbiAgfVxuXG4gIGF3YWl0IFByb21pc2UuYWxsKFxuICAgIF8ubWFwKGNoYWluUHJvdG9jb2xzLCBhc3luYyAoeyBwcm90b2NvbCwgY2hhaW5JZCwgcHJvdmlkZXIgfSkgPT4ge1xuICAgICAgY29uc3QgaXBmc0ZpbGVuYW1lID0gYCR7SURfVE9fTkVUV09SS19OQU1FKGNoYWluSWQpfS5qc29uYFxuICAgICAgbG9nLmluZm8oYEdldHRpbmcgJHtwcm90b2NvbH0gcG9vbHMgZm9yIGNoYWluICR7Y2hhaW5JZH1gKVxuICAgICAgY29uc3QgcG9vbHMgPSBhd2FpdCBwcm92aWRlci5nZXRQb29scygpXG4gICAgICBsb2cuaW5mbyhgR290ICR7cG9vbHMubGVuZ3RofSAke3Byb3RvY29sfSBwb29scyBmb3IgY2hhaW4gJHtjaGFpbklkfS4gV2lsbCBzYXZlIHdpdGggZmlsZW5hbWUgJHtpcGZzRmlsZW5hbWV9YClcbiAgICAgIGNvbnN0IHBvb2xTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShwb29scylcblxuICAgICAgLy8gY3JlYXRlIGRpcmVjdG9yeSBhbmQgZmlsZSBmb3IgdGhlIGNoYWluIGFuZCBwcm90b2NvbFxuICAgICAgLy8gZS5nOiAvdG1wL3RlbXAvdjEvcG9vbHMvdjMvbWFpbm5ldC5qc29uXG4gICAgICBjb25zdCBwYXJlbnREaXJlY3RvcnkgPSBwYXRoLmpvaW4oRElSRUNUT1JZLCBwcm90b2NvbC50b0xvd2VyQ2FzZSgpKVxuICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLmpvaW4oRElSRUNUT1JZLCBwcm90b2NvbC50b0xvd2VyQ2FzZSgpLCBpcGZzRmlsZW5hbWUpXG4gICAgICBmcy5ta2RpclN5bmMocGFyZW50RGlyZWN0b3J5LCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KVxuICAgICAgZnMud3JpdGVGaWxlU3luYyhmdWxsUGF0aCwgcG9vbFN0cmluZylcbiAgICB9KVxuICApXG5cbiAgLy8gcGlucyBldmVyeXRoaW5nIHVuZGVyICcvdG1wL2Agd2hpY2ggc2hvdWxkIGluY2x1ZGUgbWFpbm5ldC50eHQgYW5kIHJpbmtlYnkudHh0XG4gIC8vIG9ubHkgaGF2ZSB0byBwaW4gb25jZSBmb3IgYWxsIGNoYWluc1xuICBsZXQgcmVzdWx0XG4gIGxldCBoYXNoXG4gIHRyeSB7XG4gICAgbG9nLmluZm8oeyByZXN1bHQgfSwgYFBpbm5pbmcgdG8gcGluYXRhOiAke1BBUkVOVH1gKVxuICAgIHJlc3VsdCA9IGF3YWl0IHBpbmF0YS5waW5Gcm9tRlMoUEFSRU5UKVxuICAgIGNvbnN0IHVybCA9IGBodHRwczovL2lwZnMuaW8vaXBmcy8ke3Jlc3VsdC5JcGZzSGFzaH1gXG4gICAgaGFzaCA9IHJlc3VsdC5JcGZzSGFzaFxuXG4gICAgbG9nLmluZm8oeyByZXN1bHQgfSwgYFN1Y2Nlc3NmdWwgcGlubmluZy4gSVBGUyBoYXNoOiAke2hhc2h9IGFuZCB1cmwgOiAke3VybH1gKVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3IoeyBlcnIgfSwgJ0Vycm9yIHBpbm5pbmcnKVxuICAgIHRocm93IGVyclxuICB9XG5cbiAgLy8gbGluayByZXN1bHRpbmcgaGFzaCB0byBETlNcbiAgY29uc3QgZG9tYWluID0gcHJvY2Vzcy5lbnYuU1RBR0UgPT0gJ3Byb2QnID8gJ2FwaS51bmlzd2FwLm9yZycgOiAnYmV0YS5hcGkudW5pc3dhcC5vcmcnXG4gIHZhciBwYXJhbXMgPSB7XG4gICAgQ2hhbmdlQmF0Y2g6IHtcbiAgICAgIENoYW5nZXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjdGlvbjogJ1VQU0VSVCcsXG4gICAgICAgICAgUmVzb3VyY2VSZWNvcmRTZXQ6IHtcbiAgICAgICAgICAgIE5hbWU6IGRvbWFpbixcbiAgICAgICAgICAgIFJlc291cmNlUmVjb3JkczogW1xuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgVmFsdWU6IGBcXFwiZG5zbGluaz0vaXBmcy8ke2hhc2h9XFxcImAsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgVFRMOiA2MCxcbiAgICAgICAgICAgIFR5cGU6ICdUWFQnLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0sXG4gICAgSG9zdGVkWm9uZUlkOiBwcm9jZXNzLmVudi5IT1NURURfWk9ORSEsXG4gIH1cbiAgdHJ5IHtcbiAgICBsb2cuaW5mbyh7IHBhcmFtcyB9LCBgVXBkYXRpbmcgcmVjb3JkIHNldGApXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJvdXRlNTMuY2hhbmdlUmVzb3VyY2VSZWNvcmRTZXRzKHBhcmFtcykucHJvbWlzZSgpXG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWwgcmVjb3JkIHVwZGF0ZTogJHtkYXRhfWApXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvcih7IGVyciB9LCAnRXJyb3IgdXBkYXRpbmcgRE5TJylcbiAgICB0aHJvdyBlcnJcbiAgfVxufVxubW9kdWxlLmV4cG9ydHMgPSB7IGhhbmRsZXIgfVxuIl19