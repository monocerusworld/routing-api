import pinataSDK from '@pinata/sdk';
import { default as bunyan } from 'bunyan';
function delay(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
}
const START_MONTHS_AGO = 2;
const END_MONTHS_AGO = 1;
const PAGE_SIZE = 1000;
const pinata = pinataSDK(process.env.PINATA_API_KEY, process.env.PINATA_API_SECRET);
const handler = async (event) => {
    const log = bunyan.createLogger({
        name: 'CleanIPFSPoolCacheLambda',
        serializers: bunyan.stdSerializers,
        level: 'info',
        requestId: event.id,
    });
    const now = new Date();
    const startDate = new Date(now.getFullYear(), now.getMonth() - START_MONTHS_AGO, now.getDate());
    const endDate = new Date(now.getFullYear(), now.getMonth() - END_MONTHS_AGO, now.getDate());
    let unpinned = 0;
    let count = 1;
    while (unpinned < count) {
        const filters = {
            status: 'pinned',
            pinStart: startDate.toISOString(),
            pinEnd: endDate.toISOString(),
            // retrieve only the pool data (called temp for now)
            metadata: { name: 'temp', keyvalues: {} },
            pageLimit: PAGE_SIZE,
            // Do not need to change offset, getting new data from pinList each time.
            pageOffset: 0,
        };
        let result;
        try {
            result = await pinata.pinList(filters);
            // 3 requests per second is max allowed by Pinata API. We ensure we do not exceed 2 requests per second to give a buffer.
            await delay(500);
        }
        catch (err) {
            log.error({ err }, `Error on pinList. ${JSON.stringify(err)}. Waiting one minute.`);
            await delay(60000);
            continue;
        }
        if (count == 1) {
            // set count
            count = result.count;
            log.info({ startDate, endDate }, `Overall pins count between ${startDate.toDateString()} and ${endDate.toDateString()}: ${count}`);
        }
        for (let i = 0; i < result.rows.length; i += 1) {
            const { ipfs_pin_hash: hash, date_pinned: datePinned } = result.rows[i];
            try {
                const response = await pinata.unpin(hash);
                // 3 requests per second is max allowed by Pinata API. We ensure we do not exceed 2 requests per second to give a buffer.
                await delay(500);
                unpinned += 1;
                log.info({ response, hash }, `Unpinned: ${hash} pinned at ${datePinned}`);
            }
            catch (err) {
                if (err.reason == 'CURRENT_USER_HAS_NOT_PINNED_CID') {
                    log.error({ err }, `Error ${err.reason} - Unpinned ${unpinned} so far. Skipping current pin`);
                }
                else {
                    log.error({ err }, `Error ${err.reason} - Unpinned ${unpinned} so far. Waiting one minute`);
                    await delay(60000);
                    // set i back one since it was an unsuccessful unpin
                    i -= 1;
                }
            }
            log.info(`Unpinned ${unpinned} out of ${result.rows.length} from current page.`);
        }
    }
    log.info(`Unpinned all ${unpinned} pins out of ${count} in the date range.`);
};
module.exports = { handler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xlYW4tcG9vbHMtaXBmcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jcm9uL2NsZWFuLXBvb2xzLWlwZnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFBO0FBRW5DLE9BQU8sRUFBRSxPQUFPLElBQUksTUFBTSxFQUFxQixNQUFNLFFBQVEsQ0FBQTtBQUU3RCxTQUFTLEtBQUssQ0FBQyxFQUFVO0lBQ3ZCLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUMxRCxDQUFDO0FBRUQsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLENBQUE7QUFDMUIsTUFBTSxjQUFjLEdBQUcsQ0FBQyxDQUFBO0FBRXhCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQTtBQUV0QixNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFlLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBa0IsQ0FBQyxDQUFBO0FBRXJGLE1BQU0sT0FBTyxHQUFxQixLQUFLLEVBQUUsS0FBcUMsRUFBRSxFQUFFO0lBQ2hGLE1BQU0sR0FBRyxHQUFXLE1BQU0sQ0FBQyxZQUFZLENBQUM7UUFDdEMsSUFBSSxFQUFFLDBCQUEwQjtRQUNoQyxXQUFXLEVBQUUsTUFBTSxDQUFDLGNBQWM7UUFDbEMsS0FBSyxFQUFFLE1BQU07UUFDYixTQUFTLEVBQUUsS0FBSyxDQUFDLEVBQUU7S0FDcEIsQ0FBQyxDQUFBO0lBRUYsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQTtJQUN0QixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRSxHQUFHLGdCQUFnQixFQUFFLEdBQUcsQ0FBQyxPQUFPLEVB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WUFDRCxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksUUFBUSxXQUFXLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxxQkFBcUIsQ0FBQyxDQUFBO1NBQ2pGO0tBQ0Y7SUFFRCxHQUFHLENBQUMsSUFBSSxDQUFDLGdCQUFnQixRQUFRLGdCQUFnQixLQUFLLHFCQUFxQixDQUFDLENBQUE7QUFDOUUsQ0FBQyxDQUFBO0FBQ0QsTUFBTSxDQUFDLE9BQU8sR0FBRyxFQUFFLE9BQU8sRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBpbmF0YVNESyBmcm9tICdAcGluYXRhL3NkaydcbmltcG9ydCB7IEV2ZW50QnJpZGdlRXZlbnQsIFNjaGVkdWxlZEhhbmRsZXIgfSBmcm9tICdhd3MtbGFtYmRhJ1xuaW1wb3J0IHsgZGVmYXVsdCBhcyBidW55YW4sIGRlZmF1bHQgYXMgTG9nZ2VyIH0gZnJvbSAnYnVueWFuJ1xuXG5mdW5jdGlvbiBkZWxheShtczogbnVtYmVyKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpXG59XG5cbmNvbnN0IFNUQVJUX01PTlRIU19BR08gPSAyXG5jb25zdCBFTkRfTU9OVEhTX0FHTyA9IDFcblxuY29uc3QgUEFHRV9TSVpFID0gMTAwMFxuXG5jb25zdCBwaW5hdGEgPSBwaW5hdGFTREsocHJvY2Vzcy5lbnYuUElOQVRBX0FQSV9LRVkhLCBwcm9jZXNzLmVudi5QSU5BVEFfQVBJX1NFQ1JFVCEpXG5cbmNvbnN0IGhhbmRsZXI6IFNjaGVkdWxlZEhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEV2ZW50QnJpZGdlRXZlbnQ8c3RyaW5nLCB2b2lkPikgPT4ge1xuICBjb25zdCBsb2c6IExvZ2dlciA9IGJ1bnlhbi5jcmVhdGVMb2dnZXIoe1xuICAgIG5hbWU6ICdDbGVhbklQRlNQb29sQ2FjaGVMYW1iZGEnLFxuICAgIHNlcmlhbGl6ZXJzOiBidW55YW4uc3RkU2VyaWFsaXplcnMsXG4gICAgbGV2ZWw6ICdpbmZvJyxcbiAgICByZXF1ZXN0SWQ6IGV2ZW50LmlkLFxuICB9KVxuXG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKClcbiAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUobm93LmdldEZ1bGxZZWFyKCksIG5vdy5nZXRNb250aCgpIC0gU1RBUlRfTU9OVEhTX0FHTywgbm93LmdldERhdGUoKSlcbiAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKG5vdy5nZXRGdWxsWWVhcigpLCBub3cuZ2V0TW9udGgoKSAtIEVORF9NT05USFNfQUdPLCBub3cuZ2V0RGF0ZSgpKVxuXG4gIGxldCB1bnBpbm5lZCA9IDBcbiAgbGV0IGNvdW50ID0gMVxuXG4gIHdoaWxlICh1bnBpbm5lZCA8IGNvdW50KSB7XG4gICAgY29uc3QgZmlsdGVycyA9IHtcbiAgICAgIHN0YXR1czogJ3Bpbm5lZCcsXG4gICAgICBwaW5TdGFydDogc3RhcnREYXRlLnRvSVNPU3RyaW5nKCksXG4gICAgICBwaW5FbmQ6IGVuZERhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgIC8vIHJldHJpZXZlIG9ubHkgdGhlIHBvb2wgZGF0YSAoY2FsbGVkIHRlbXAgZm9yIG5vdylcbiAgICAgIG1ldGFkYXRhOiB7IG5hbWU6ICd0ZW1wJywga2V5dmFsdWVzOiB7fSB9LFxuICAgICAgcGFnZUxpbWl0OiBQQUdFX1NJWkUsXG4gICAgICAvLyBEbyBub3QgbmVlZCB0byBjaGFuZ2Ugb2Zmc2V0LCBnZXR0aW5nIG5ldyBkYXRhIGZyb20gcGluTGlzdCBlYWNoIHRpbWUuXG4gICAgICBwYWdlT2Zmc2V0OiAwLFxuICAgIH1cblxuICAgIGxldCByZXN1bHRcbiAgICB0cnkge1xuICAgICAgcmVzdWx0ID0gYXdhaXQgcGluYXRhLnBpbkxpc3QoZmlsdGVycylcbiAgICAgIC8vIDMgcmVxdWVzdHMgcGVyIHNlY29uZCBpcyBtYXggYWxsb3dlZCBieSBQaW5hdGEgQVBJLiBXZSBlbnN1cmUgd2UgZG8gbm90IGV4Y2VlZCAyIHJlcXVlc3RzIHBlciBzZWNvbmQgdG8gZ2l2ZSBhIGJ1ZmZlci5cbiAgICAgIGF3YWl0IGRlbGF5KDUwMClcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvcih7IGVyciB9LCBgRXJyb3Igb24gcGluTGlzdC4gJHtKU09OLnN0cmluZ2lmeShlcnIpfS4gV2FpdGluZyBvbmUgbWludXRlLmApXG4gICAgICBhd2FpdCBkZWxheSg2MDAwMClcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgaWYgKGNvdW50ID09IDEpIHtcbiAgICAgIC8vIHNldCBjb3VudFxuICAgICAgY291bnQgPSByZXN1bHQuY291bnRcbiAgICAgIGxvZy5pbmZvKFxuICAgICAgICB7IHN0YXJ0RGF0ZSwgZW5kRGF0ZSB9LFxuICAgICAgICBgT3ZlcmFsbCBwaW5zIGNvdW50IGJldHdlZW4gJHtzdGFydERhdGUudG9EYXRlU3RyaW5nKCl9IGFuZCAke2VuZERhdGUudG9EYXRlU3RyaW5nKCl9OiAke2NvdW50fWBcbiAgICAgIClcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5yb3dzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICBjb25zdCB7IGlwZnNfcGluX2hhc2g6IGhhc2gsIGRhdGVfcGlubmVkOiBkYXRlUGlubmVkIH0gPSByZXN1bHQucm93c1tpXVxuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHBpbmF0YS51bnBpbihoYXNoKVxuXG4gICAgICAgIC8vIDMgcmVxdWVzdHMgcGVyIHNlY29uZCBpcyBtYXggYWxsb3dlZCBieSBQaW5hdGEgQVBJLiBXZSBlbnN1cmUgd2UgZG8gbm90IGV4Y2VlZCAyIHJlcXVlc3RzIHBlciBzZWNvbmQgdG8gZ2l2ZSBhIGJ1ZmZlci5cbiAgICAgICAgYXdhaXQgZGVsYXkoNTAwKVxuXG4gICAgICAgIHVucGlubmVkICs9IDFcbiAgICAgICAgbG9nLmluZm8oeyByZXNwb25zZSwgaGFzaCB9LCBgVW5waW5uZWQ6ICR7aGFzaH0gcGlubmVkIGF0ICR7ZGF0ZVBpbm5lZH1gKVxuICAgICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgICAgaWYgKGVyci5yZWFzb24gPT0gJ0NVUlJFTlRfVVNFUl9IQVNfTk9UX1BJTk5FRF9DSUQnKSB7XG4gICAgICAgICAgbG9nLmVycm9yKHsgZXJyIH0sIGBFcnJvciAke2Vyci5yZWFzb259IC0gVW5waW5uZWQgJHt1bnBpbm5lZH0gc28gZmFyLiBTa2lwcGluZyBjdXJyZW50IHBpbmApXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nLmVycm9yKHsgZXJyIH0sIGBFcnJvciAke2Vyci5yZWFzb259IC0gVW5waW5uZWQgJHt1bnBpbm5lZH0gc28gZmFyLiBXYWl0aW5nIG9uZSBtaW51dGVgKVxuICAgICAgICAgIGF3YWl0IGRlbGF5KDYwMDAwKVxuICAgICAgICAgIC8vIHNldCBpIGJhY2sgb25lIHNpbmNlIGl0IHdhcyBhbiB1bnN1Y2Nlc3NmdWwgdW5waW5cbiAgICAgICAgICBpIC09IDFcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbG9nLmluZm8oYFVucGlubmVkICR7dW5waW5uZWR9IG91dCBvZiAke3Jlc3VsdC5yb3dzLmxlbmd0aH0gZnJvbSBjdXJyZW50IHBhZ2UuYClcbiAgICB9XG4gIH1cblxuICBsb2cuaW5mbyhgVW5waW5uZWQgYWxsICR7dW5waW5uZWR9IHBpbnMgb3V0IG9mICR7Y291bnR9IGluIHRoZSBkYXRlIHJhbmdlLmApXG59XG5tb2R1bGUuZXhwb3J0cyA9IHsgaGFuZGxlciB9XG4iXX0=