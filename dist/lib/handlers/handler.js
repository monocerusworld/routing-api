import { metricScope } from 'aws-embedded-metrics';
import { default as bunyan } from 'bunyan';
export class UnsupportedChainError extends Error {
    constructor(chainId) {
        super();
        this.chainId = chainId;
        this.name = 'UnsupportedChainError';
    }
}
export class Injector {
    constructor(injectorName) {
        this.injectorName = injectorName;
    }
    async build() {
        this.containerInjected = await this.buildContainerInjected();
        return this;
    }
    async getContainerInjected() {
        if (this.containerInjected === undefined) {
            throw new Error('Container injected undefined. Must call build() before using.');
        }
        return this.containerInjected;
    }
}
const INTERNAL_ERROR = (id) => {
    return {
        statusCode: 500,
        body: JSON.stringify({
            errorCode: 'INTERNAL_ERROR',
            detail: 'Unexpected error',
            id,
        }),
    };
};
export class APIGLambdaHandler {
    constructor(handlerName, injectorPromise) {
        this.handlerName = handlerName;
        this.injectorPromise = injectorPromise;
    }
    get handler() {
        return async (event, context) => {
            const handler = this.buildHandler();
            const response = await handler(event, context);
            return {
                ...response,
                headers: {
                    ...response.headers,
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token',
                    'Access-Control-Allow-Credentials': true,
                    'Content-Type': 'application/json',
                },
            };
        };
    }
    buildHandler() {
        return metricScope((metric) => async (event, context) => {
            let log = bunyan.createLogger({
                name: this.handlerName,
                serializers: bunyan.stdSerializers,
                level: bunyan.INFO,
                requestId: context.awsRequestId,
            });
            const requestStart = Date.now();
            log.info({ event, context }, 'Request started.');
            let requestBody;
            let requestQueryParams;
            try {
                const requestValidation = await this.parseAndValidateRequest(event, log);
                if (requestValidation.state == 'invalid') {
                    return requestValidation.errorResponse;
                }
                requestBody = requestValidation.requestBody;
                requestQueryParams = requestValidation.requestQueryParams;
            }
            catch (err) {
                log.error({ err }, 'Unexpected error validating request');
                return INTERNAL_ERROR();
            }
            const injector = await this.injectorPromise;
            const containerInjected = await injector.getContainerInjected();
            let requestInjected;
            try {
                requestInjected = await injector.getRequestInjected(containerInjected, requestBody, requestQueryParams, event, context, log, metric);
            }
            catch (err) {
                log.error({ err, event }, 'Unexpected error building request injected.');
                return INTERNAL_ERROR();
            }
            const { id } = requestInjected;
            ({ log } = requestInjected);
            let statusCode;
            let body;
            try {
                const handleRequestResult = await this.handleRequest({
                    context,
                    event,
                    requestBody,
                    requestQueryParams,
                    containerInjected,
                    requestInjected,
                });
                if (this.isError(handleRequestResult)) {
                    log.info({ handleRequestResult }, 'Handler did not return a 200');
                    const { statusCode, detail, errorCode } = handleRequestResult;
                    const response = JSON.stringify({ detail, errorCode, id });
                    log.info({ statusCode, response }, `Request ended. ${statusCode}`);
                    return {
                        statusCode,
                        body: response,
                    };
                }
                else {
                    log.info({ requestBody, requestQueryParams, requestDuration: Date.now() - requestStart }, 'Handler returned 200');
                    ({ body, statusCode } = handleRequestResult);
                }
            }
            catch (err) {
                log.error({ err }, 'Unexpected error in handler');
                return INTERNAL_ERROR(id);
            }
            let response;
            try {
                const responseValidation = await this.parseAndValidateResponse(body, id, log);
                if (responseValidation.state == 'invalid') {
                    return responseValidation.errorResponse;
                }
                response = responseValidation.response;
            }
            catch (err) {
                log.error({ err }, 'Unexpected error validating response');
                return INTERNAL_ERROR(id);
            }
            log.info({ statusCode, response }, `Request ended. ${statusCode}`);
            return {
                statusCode,
                body: JSON.stringify(response),
            };
        });
    }
    isError(result) {
        return result.statusCode != 200 && result.statusCode != 202;
    }
    async parseAndValidateRequest(event, log) {
        let bodyRaw;
        if (event.body) {
            try {
                bodyRaw = JSON.parse(event.body);
            }
            catch (err) {
                return {
                    state: 'invalid',
                    errorResponse: {
                        statusCode: 422,
                        body: JSON.stringify({
                            detail: 'Invalid JSON body',
                            errorCode: 'VALIDATION_ERROR',
                        }),
                    },
                };
            }
        }
        let queryParamsRaw = event.queryStringParameters;
        const queryParamsSchema = this.requestQueryParamsSchema();
        let queryParams;
        if (queryParamsRaw && queryParamsSchema) {
            const queryParamsValidation = queryParamsSchema.validate(queryParamsRaw, {
                allowUnknown: true,
                stripUnknown: true,
            });
            if (queryParamsValidation.error) {
                log.info({ queryParamsValidation }, 'Request failed validation');
                return {
                    state: 'invalid',
                    errorResponse: {
                        statusCode: 400,
                        body: JSON.stringify({
                            detail: queryParamsValidation.error.message,
                            errorCode: 'VALIDATION_ERROR',
                        }),
                    },
                };
            }
            queryParams = queryParamsValidation.value;
        }
        const bodySchema = this.requestBodySchema();
        let body;
        if (bodyRaw && bodySchema) {
            const bodyValidation = bodySchema.validate(bodyRaw, {
                allowUnknown: true,
                stripUnknown: true,
            });
            if (bodyValidation.error) {
                log.info({ bodyValidation }, 'Request failed validation');
                return {
                    state: 'invalid',
                    errorResponse: {
                        statusCode: 400,
                        body: JSON.stringify({
                            detail: bodyValidation.error.message,
                            errorCode: 'VALIDATION_ERROR',
                        }),
                    },
                };
            }
            body = bodyValidation.value;
        }
        return {
            state: 'valid',
            requestBody: body,
            requestQueryParams: queryParams,
        };
    }
    async parseAndValidateResponse(body, id, log) {
        var _a, _b;
        const responseSchema = this.responseBodySchema();
        if (!responseSchema) {
            return { state: 'valid', response: body };
        }
        const res = responseSchema.validate(body, {
            allowUnknown: true,
            stripUnknown: true, // Ensure no unexpected fields returned to users.
        });
        if (res.error) {
            log.error({ error: (_a = res.error) === null || _a === void 0 ? void 0 : _a.details, errors: (_b = res.errors) === null || _b === void 0 ? void 0 : _b.details, body }, 'Unexpected error. Response failed validation.');
            return {
                state: 'invalid',
                errorResponse: INTERNAL_ERROR(id),
            };
        }
        return { state: 'valid', response: res.value };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9oYW5kbGVycy9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQWlCLE1BQU0sc0JBQXNCLENBQUE7QUFPakUsT0FBTyxFQUFFLE9BQU8sSUFBSSxNQUFNLEVBQXFCLE1BQU0sUUFBUSxDQUFBO0FBOEI3RCxNQUFNLE9BQU8scUJBQXNCLFNBQVEsS0FBSztJQUM5QyxZQUFtQixPQUFlO1FBQ2hDLEtBQUssRUFBRSxDQUFBO1FBRFUsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUczQixTQUFJLEdBQUcsdUJBQXVCLENBQUE7SUFEckMsQ0FBQztDQUVGO0FBRUQsTUFBTSxPQUFnQixRQUFRO0lBRTVCLFlBQTZCLFlBQW9CO1FBQXBCLGlCQUFZLEdBQVosWUFBWSxDQUFRO0lBQUcsQ0FBQztJQUU5QyxLQUFLLENBQUMsS0FBSztRQUNoQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQTtRQUM1RCxPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFjTSxLQUFLLENBQUMsb0JBQW9CO1FBQy9CLElBQUksSUFBSSxDQUFDLGlCQUFpQixLQUFLLFNBQVMsRUFBRTtZQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLCtEQUErRCxDQUFDLENBQUE7U0FDakY7UUFDRCxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQTtJQUMvQixDQUFDO0NBQ0Y7QUFFRCxNQUFNLGNBQWMsR0FBRyxDQUFDLEVBQVcsRUFBRSxFQUFFO0lBQ3JDLE9BQU87UUFDTCxVQUFVLEVBQUUsR0FBRztRQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ25CLFNBQVMsRUFBRSxnQkFBZ0I7WUFDM0IsTUFBTSxFQUFFLGtCQUFrQjtZQUMxQixFQUFFO1NBQ0gsQ0FBQztLQUNILENBQUE7QUFDSCxDQUFDLENB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LEVBQUUsS0FBSyxFQUFFLE1BQUEsR0FBRyxDQUFDLEtBQUssMENBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFBLEdBQUcsQ0FBQyxNQUFNLDBDQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFDaEUsK0NBQStDLENBQ2hELENBQUE7WUFDRCxPQUFPO2dCQUNMLEtBQUssRUFBRSxTQUFTO2dCQUNoQixhQUFhLEVBQUUsY0FBYyxDQUFDLEVBQUUsQ0FBQzthQUNsQyxDQUFBO1NBQ0Y7UUFFRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsR0FBRyxDQUFDLEtBQVksRUFBRSxDQUFBO0lBQ3ZELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBKb2kgZnJvbSAnQGhhcGkvam9pJ1xuaW1wb3J0IHsgbWV0cmljU2NvcGUsIE1ldHJpY3NMb2dnZXIgfSBmcm9tICdhd3MtZW1iZWRkZWQtbWV0cmljcydcbmltcG9ydCB7XG4gIEFQSUdhdGV3YXlQcm94eUV2ZW50LFxuICBBUElHYXRld2F5UHJveHlFdmVudFF1ZXJ5U3RyaW5nUGFyYW1ldGVycyxcbiAgQVBJR2F0ZXdheVByb3h5UmVzdWx0LFxuICBDb250ZXh0LFxufSBmcm9tICdhd3MtbGFtYmRhJ1xuaW1wb3J0IHsgZGVmYXVsdCBhcyBidW55YW4sIGRlZmF1bHQgYXMgTG9nZ2VyIH0gZnJvbSAnYnVueWFuJ1xuXG5leHBvcnQgdHlwZSBBUElHYXRld2F5UHJveHlIYW5kbGVyID0gKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCwgY29udGV4dDogQ29udGV4dCkgPT4gUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+XG5cbmV4cG9ydCB0eXBlIEJhc2VSSW5qID0ge1xuICBsb2c6IExvZ2dlclxuICBpZDogc3RyaW5nXG59XG5cbmV4cG9ydCB0eXBlIEhhbmRsZVJlcXVlc3RQYXJhbXM8Q0luaiwgUkluaiwgUmVxQm9keSwgUmVxUXVlcnlQYXJhbXM+ID0ge1xuICBjb250ZXh0OiBDb250ZXh0XG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFxuICByZXF1ZXN0Qm9keTogUmVxQm9keVxuICByZXF1ZXN0UXVlcnlQYXJhbXM6IFJlcVF1ZXJ5UGFyYW1zXG4gIGNvbnRhaW5lckluamVjdGVkOiBDSW5qXG4gIHJlcXVlc3RJbmplY3RlZDogUklualxufVxuXG5leHBvcnQgdHlwZSBSZXNwb25zZTxSZXM+ID0ge1xuICBzdGF0dXNDb2RlOiAyMDAgfCAyMDJcbiAgYm9keTogUmVzXG4gIGhlYWRlcnM/OiBhbnlcbn1cblxuZXhwb3J0IHR5cGUgRXJyb3JSZXNwb25zZSA9IHtcbiAgc3RhdHVzQ29kZTogNDAwIHwgNDAzIHwgNDA0IHwgNDA4IHwgNDA5IHwgNTAwXG4gIGVycm9yQ29kZTogc3RyaW5nXG4gIGRldGFpbD86IHN0cmluZ1xufVxuXG5leHBvcnQgY2xhc3MgVW5zdXBwb3J0ZWRDaGFpbkVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgY2hhaW5JZDogbnVtYmVyKSB7XG4gICAgc3VwZXIoKVxuICB9XG4gIHB1YmxpYyBuYW1lID0gJ1Vuc3VwcG9ydGVkQ2hhaW5FcnJvcidcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEluamVjdG9yPENJbmosIFJJbmogZXh0ZW5kcyBCYXNlUkluaiwgUmVxQm9keSwgUmVxUXVlcnlQYXJhbXM+IHtcbiAgcHJpdmF0ZSBjb250YWluZXJJbmplY3RlZDogQ0lualxuICBwdWJsaWMgY29uc3RydWN0b3IocHJvdGVjdGVkIGluamVjdG9yTmFtZTogc3RyaW5nKSB7fVxuXG4gIHB1YmxpYyBhc3luYyBidWlsZCgpIHtcbiAgICB0aGlzLmNvbnRhaW5lckluamVjdGVkID0gYXdhaXQgdGhpcy5idWlsZENvbnRhaW5lckluamVjdGVkKClcbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgcHVibGljIGFic3RyYWN0IGdldFJlcXVlc3RJbmplY3RlZChcbiAgICBjb250YWluZXJJbmplY3RlZDogQ0luaixcbiAgICByZXF1ZXN0Qm9keTogUmVxQm9keSxcbiAgICByZXF1ZXN0UXVlcnlQYXJhbXM6IFJlcVF1ZXJ5UGFyYW1zLFxuICAgIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCxcbiAgICBjb250ZXh0OiBDb250ZXh0LFxuICAgIGxvZzogTG9nZ2VyLFxuICAgIG1ldHJpY3M6IE1ldHJpY3NMb2dnZXJcbiAgKTogUHJvbWlzZTxSSW5qPlxuXG4gIHB1YmxpYyBhYnN0cmFjdCBidWlsZENvbnRhaW5lckluamVjdGVkKCk6IFByb21pc2U8Q0luaj5cblxuICBwdWJsaWMgYXN5bmMgZ2V0Q29udGFpbmVySW5qZWN0ZWQoKTogUHJvbWlzZTxDSW5qPiB7XG4gICAgaWYgKHRoaXMuY29udGFpbmVySW5qZWN0ZWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb250YWluZXIgaW5qZWN0ZWQgdW5kZWZpbmVkLiBNdXN0IGNhbGwgYnVpbGQoKSBiZWZvcmUgdXNpbmcuJylcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29udGFpbmVySW5qZWN0ZWRcbiAgfVxufVxuXG5jb25zdCBJTlRFUk5BTF9FUlJPUiA9IChpZD86IHN0cmluZykgPT4ge1xuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBlcnJvckNvZGU6ICdJTlRFUk5BTF9FUlJPUicsXG4gICAgICBkZXRhaWw6ICdVbmV4cGVjdGVkIGVycm9yJyxcbiAgICAgIGlkLFxuICAgIH0pLFxuICB9XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBUElHTGFtYmRhSGFuZGxlcjxDSW5qLCBSSW5qIGV4dGVuZHMgQmFzZVJJbmosIFJlcUJvZHksIFJlcVF1ZXJ5UGFyYW1zLCBSZXM+IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBoYW5kbGVyTmFtZTogc3RyaW5nLFxuICAgIHByaXZhdGUgaW5qZWN0b3JQcm9taXNlOiBQcm9taXNlPEluamVjdG9yPENJbmosIFJJbmosIFJlcUJvZHksIFJlcVF1ZXJ5UGFyYW1zPj5cbiAgKSB7fVxuXG4gIGdldCBoYW5kbGVyKCk6IEFQSUdhdGV3YXlQcm94eUhhbmRsZXIge1xuICAgIHJldHVybiBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBjb250ZXh0OiBDb250ZXh0KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgICAgIGNvbnN0IGhhbmRsZXIgPSB0aGlzLmJ1aWxkSGFuZGxlcigpXG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcihldmVudCwgY29udGV4dClcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4ucmVzcG9uc2UsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAuLi5yZXNwb25zZS5oZWFkZXJzLFxuICAgICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLFgtQW16LURhdGUsQXV0aG9yaXphdGlvbixYLUFwaS1LZXksWC1BbXotU2VjdXJpdHktVG9rZW4nLFxuICAgICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1DcmVkZW50aWFscyc6IHRydWUsXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkSGFuZGxlcigpOiBBUElHYXRld2F5UHJveHlIYW5kbGVyIHtcbiAgICByZXR1cm4gbWV0cmljU2NvcGUoXG4gICAgICAobWV0cmljOiBNZXRyaWNzTG9nZ2VyKSA9PlxuICAgICAgICBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBjb250ZXh0OiBDb250ZXh0KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgICAgICAgICBsZXQgbG9nOiBMb2dnZXIgPSBidW55YW4uY3JlYXRlTG9nZ2VyKHtcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuaGFuZGxlck5hbWUsXG4gICAgICAgICAgICBzZXJpYWxpemVyczogYnVueWFuLnN0ZFNlcmlhbGl6ZXJzLFxuICAgICAgICAgICAgbGV2ZWw6IGJ1bnlhbi5JTkZPLFxuICAgICAgICAgICAgcmVxdWVzdElkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgY29uc3QgcmVxdWVzdFN0YXJ0ID0gRGF0ZS5ub3coKVxuICAgICAgICAgIGxvZy5pbmZvKHsgZXZlbnQsIGNvbnRleHQgfSwgJ1JlcXVlc3Qgc3RhcnRlZC4nKVxuXG4gICAgICAgICAgbGV0IHJlcXVlc3RCb2R5OiBSZXFCb2R5XG4gICAgICAgICAgbGV0IHJlcXVlc3RRdWVyeVBhcmFtczogUmVxUXVlcnlQYXJhbXNcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdFZhbGlkYXRpb24gPSBhd2FpdCB0aGlzLnBhcnNlQW5kVmFsaWRhdGVSZXF1ZXN0KGV2ZW50LCBsb2cpXG5cbiAgICAgICAgICAgIGlmIChyZXF1ZXN0VmFsaWRhdGlvbi5zdGF0ZSA9PSAnaW52YWxpZCcpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlcXVlc3RWYWxpZGF0aW9uLmVycm9yUmVzcG9uc2VcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVxdWVzdEJvZHkgPSByZXF1ZXN0VmFsaWRhdGlvbi5yZXF1ZXN0Qm9keVxuICAgICAgICAgICAgcmVxdWVzdFF1ZXJ5UGFyYW1zID0gcmVxdWVzdFZhbGlkYXRpb24ucmVxdWVzdFF1ZXJ5UGFyYW1zXG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBsb2cuZXJyb3IoeyBlcnIgfSwgJ1VuZXhwZWN0ZWQgZXJyb3IgdmFsaWRhdGluZyByZXF1ZXN0JylcbiAgICAgICAgICAgIHJldHVybiBJTlRFUk5BTF9FUlJPUigpXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgaW5qZWN0b3IgPSBhd2FpdCB0aGlzLmluamVjdG9yUHJvbWlzZVxuXG4gICAgICAgICAgY29uc3QgY29udGFpbmVySW5qZWN0ZWQgPSBhd2FpdCBpbmplY3Rvci5nZXRDb250YWluZXJJbmplY3RlZCgpXG5cbiAgICAgICAgICBsZXQgcmVxdWVzdEluamVjdGVkOiBSSW5qXG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJlcXVlc3RJbmplY3RlZCA9IGF3YWl0IGluamVjdG9yLmdldFJlcXVlc3RJbmplY3RlZChcbiAgICAgICAgICAgICAgY29udGFpbmVySW5qZWN0ZWQsXG4gICAgICAgICAgICAgIHJlcXVlc3RCb2R5LFxuICAgICAgICAgICAgICByZXF1ZXN0UXVlcnlQYXJhbXMsXG4gICAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgICBsb2csXG4gICAgICAgICAgICAgIG1ldHJpY1xuICAgICAgICAgICAgKVxuICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgbG9nLmVycm9yKHsgZXJyLCBldmVudCB9LCAnVW5leHBlY3RlZCBlcnJvciBidWlsZGluZyByZXF1ZXN0IGluamVjdGVkLicpXG4gICAgICAgICAgICByZXR1cm4gSU5URVJOQUxfRVJST1IoKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcXVlc3RJbmplY3RlZFxuXG4gICAgICAgICAgOyh7IGxvZyB9ID0gcmVxdWVzdEluamVjdGVkKVxuXG4gICAgICAgICAgbGV0IHN0YXR1c0NvZGU6IG51bWJlclxuICAgICAgICAgIGxldCBib2R5OiBSZXNcblxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBoYW5kbGVSZXF1ZXN0UmVzdWx0ID0gYXdhaXQgdGhpcy5oYW5kbGVSZXF1ZXN0KHtcbiAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgZXZlbnQsXG4gICAgICAgICAgICAgIHJlcXVlc3RCb2R5LFxuICAgICAgICAgICAgICByZXF1ZXN0UXVlcnlQYXJhbXMsXG4gICAgICAgICAgICAgIGNvbnRhaW5lckluamVjdGVkLFxuICAgICAgICAgICAgICByZXF1ZXN0SW5qZWN0ZWQsXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBpZiAodGhpcy5pc0Vycm9yKGhhbmRsZVJlcXVlc3RSZXN1bHQpKSB7XG4gICAgICAgICAgICAgIGxvZy5pbmZvKHsgaGFuZGxlUmVxdWVzdFJlc3VsdCB9LCAnSGFuZGxlciBkaWQgbm90IHJldHVybiBhIDIwMCcpXG4gICAgICAgICAgICAgIGNvbnN0IHsgc3RhdHVzQ29kZSwgZGV0YWlsLCBlcnJvckNvZGUgfSA9IGhhbmRsZVJlcXVlc3RSZXN1bHRcbiAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBKU09OLnN0cmluZ2lmeSh7IGRldGFpbCwgZXJyb3JDb2RlLCBpZCB9KVxuXG4gICAgICAgICAgICAgIGxvZy5pbmZvKHsgc3RhdHVzQ29kZSwgcmVzcG9uc2UgfSwgYFJlcXVlc3QgZW5kZWQuICR7c3RhdHVzQ29kZX1gKVxuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHN0YXR1c0NvZGUsXG4gICAgICAgICAgICAgICAgYm9keTogcmVzcG9uc2UsXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGxvZy5pbmZvKFxuICAgICAgICAgICAgICAgIHsgcmVxdWVzdEJvZHksIHJlcXVlc3RRdWVyeVBhcmFtcywgcmVxdWVzdER1cmF0aW9uOiBEYXRlLm5vdygpIC0gcmVxdWVzdFN0YXJ0IH0sXG4gICAgICAgICAgICAgICAgJ0hhbmRsZXIgcmV0dXJuZWQgMjAwJ1xuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIDsoeyBib2R5LCBzdGF0dXNDb2RlIH0gPSBoYW5kbGVSZXF1ZXN0UmVzdWx0KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgbG9nLmVycm9yKHsgZXJyIH0sICdVbmV4cGVjdGVkIGVycm9yIGluIGhhbmRsZXInKVxuICAgICAgICAgICAgcmV0dXJuIElOVEVSTkFMX0VSUk9SKGlkKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGxldCByZXNwb25zZTogUmVzXG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlVmFsaWRhdGlvbiA9IGF3YWl0IHRoaXMucGFyc2VBbmRWYWxpZGF0ZVJlc3BvbnNlKGJvZHksIGlkLCBsb2cpXG5cbiAgICAgICAgICAgIGlmIChyZXNwb25zZVZhbGlkYXRpb24uc3RhdGUgPT0gJ2ludmFsaWQnKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZXNwb25zZVZhbGlkYXRpb24uZXJyb3JSZXNwb25zZVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXNwb25zZSA9IHJlc3BvbnNlVmFsaWRhdGlvbi5yZXNwb25zZVxuICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgbG9nLmVycm9yKHsgZXJyIH0sICdVbmV4cGVjdGVkIGVycm9yIHZhbGlkYXRpbmcgcmVzcG9uc2UnKVxuICAgICAgICAgICAgcmV0dXJuIElOVEVSTkFMX0VSUk9SKGlkKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGxvZy5pbmZvKHsgc3RhdHVzQ29kZSwgcmVzcG9uc2UgfSwgYFJlcXVlc3QgZW5kZWQuICR7c3RhdHVzQ29kZX1gKVxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlLFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpLFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBhYnN0cmFjdCBoYW5kbGVSZXF1ZXN0KFxuICAgIHBhcmFtczogSGFuZGxlUmVxdWVzdFBhcmFtczxDSW5qLCBSSW5qLCBSZXFCb2R5LCBSZXFRdWVyeVBhcmFtcz5cbiAgKTogUHJvbWlzZTxSZXNwb25zZTxSZXM+IHwgRXJyb3JSZXNwb25zZT5cblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgcmVxdWVzdEJvZHlTY2hlbWEoKTogSm9pLk9iamVjdFNjaGVtYSB8IG51bGxcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHJlcXVlc3RRdWVyeVBhcmFtc1NjaGVtYSgpOiBKb2kuT2JqZWN0U2NoZW1hIHwgbnVsbFxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgcmVzcG9uc2VCb2R5U2NoZW1hKCk6IEpvaS5PYmplY3RTY2hlbWEgfCBudWxsXG5cbiAgcHJpdmF0ZSBpc0Vycm9yKHJlc3VsdDogUmVzcG9uc2U8UmVzPiB8IEVycm9yUmVzcG9uc2UpOiByZXN1bHQgaXMgRXJyb3JSZXNwb25zZSB7XG4gICAgcmV0dXJuIHJlc3VsdC5zdGF0dXNDb2RlICE9IDIwMCAmJiByZXN1bHQuc3RhdHVzQ29kZSAhPSAyMDJcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcGFyc2VBbmRWYWxpZGF0ZVJlcXVlc3QoXG4gICAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LFxuICAgIGxvZzogTG9nZ2VyXG4gICk6IFByb21pc2U8XG4gICAgfCB7XG4gICAgICAgIHN0YXRlOiAndmFsaWQnXG4gICAgICAgIHJlcXVlc3RCb2R5OiBSZXFCb2R5XG4gICAgICAgIHJlcXVlc3RRdWVyeVBhcmFtczogUmVxUXVlcnlQYXJhbXNcbiAgICAgIH1cbiAgICB8IHsgc3RhdGU6ICdpbnZhbGlkJzsgZXJyb3JSZXNwb25zZTogQVBJR2F0ZXdheVByb3h5UmVzdWx0IH1cbiAgPiB7XG4gICAgbGV0IGJvZHlSYXc6IGFueVxuXG4gICAgaWYgKGV2ZW50LmJvZHkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGJvZHlSYXcgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpXG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0ZTogJ2ludmFsaWQnLFxuICAgICAgICAgIGVycm9yUmVzcG9uc2U6IHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6IDQyMixcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgZGV0YWlsOiAnSW52YWxpZCBKU09OIGJvZHknLFxuICAgICAgICAgICAgICBlcnJvckNvZGU6ICdWQUxJREFUSU9OX0VSUk9SJyxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgcXVlcnlQYXJhbXNSYXc6IEFQSUdhdGV3YXlQcm94eUV2ZW50UXVlcnlTdHJpbmdQYXJhbWV0ZXJzIHwgbnVsbCA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVyc1xuICAgIGNvbnN0IHF1ZXJ5UGFyYW1zU2NoZW1hID0gdGhpcy5yZXF1ZXN0UXVlcnlQYXJhbXNTY2hlbWEoKVxuXG4gICAgbGV0IHF1ZXJ5UGFyYW1zOiBSZXFRdWVyeVBhcmFtcyB8IHVuZGVmaW5lZFxuICAgIGlmIChxdWVyeVBhcmFtc1JhdyAmJiBxdWVyeVBhcmFtc1NjaGVtYSkge1xuICAgICAgY29uc3QgcXVlcnlQYXJhbXNWYWxpZGF0aW9uID0gcXVlcnlQYXJhbXNTY2hlbWEudmFsaWRhdGUocXVlcnlQYXJhbXNSYXcsIHtcbiAgICAgICAgYWxsb3dVbmtub3duOiB0cnVlLCAvLyBNYWtlcyBBUEkgc2NoZW1hIGNoYW5nZXMgYW5kIHJvbGxiYWNrcyBlYXNpZXIuXG4gICAgICAgIHN0cmlwVW5rbm93bjogdHJ1ZSxcbiAgICAgIH0pXG5cbiAgICAgIGlmIChxdWVyeVBhcmFtc1ZhbGlkYXRpb24uZXJyb3IpIHtcbiAgICAgICAgbG9nLmluZm8oeyBxdWVyeVBhcmFtc1ZhbGlkYXRpb24gfSwgJ1JlcXVlc3QgZmFpbGVkIHZhbGlkYXRpb24nKVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXRlOiAnaW52YWxpZCcsXG4gICAgICAgICAgZXJyb3JSZXNwb25zZToge1xuICAgICAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICBkZXRhaWw6IHF1ZXJ5UGFyYW1zVmFsaWRhdGlvbi5lcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgICBlcnJvckNvZGU6ICdWQUxJREFUSU9OX0VSUk9SJyxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcXVlcnlQYXJhbXMgPSBxdWVyeVBhcmFtc1ZhbGlkYXRpb24udmFsdWUgYXMgUmVxUXVlcnlQYXJhbXNcbiAgICB9XG5cbiAgICBjb25zdCBib2R5U2NoZW1hID0gdGhpcy5yZXF1ZXN0Qm9keVNjaGVtYSgpXG5cbiAgICBsZXQgYm9keTogUmVxQm9keSB8IHVuZGVmaW5lZFxuICAgIGlmIChib2R5UmF3ICYmIGJvZHlTY2hlbWEpIHtcbiAgICAgIGNvbnN0IGJvZHlWYWxpZGF0aW9uID0gYm9keVNjaGVtYS52YWxpZGF0ZShib2R5UmF3LCB7XG4gICAgICAgIGFsbG93VW5rbm93bjogdHJ1ZSwgLy8gTWFrZXMgQVBJIHNjaGVtYSBjaGFuZ2VzIGFuZCByb2xsYmFja3MgZWFzaWVyLlxuICAgICAgICBzdHJpcFVua25vd246IHRydWUsXG4gICAgICB9KVxuXG4gICAgICBpZiAoYm9keVZhbGlkYXRpb24uZXJyb3IpIHtcbiAgICAgICAgbG9nLmluZm8oeyBib2R5VmFsaWRhdGlvbiB9LCAnUmVxdWVzdCBmYWlsZWQgdmFsaWRhdGlvbicpXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdGU6ICdpbnZhbGlkJyxcbiAgICAgICAgICBlcnJvclJlc3BvbnNlOiB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgIGRldGFpbDogYm9keVZhbGlkYXRpb24uZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgICAgZXJyb3JDb2RlOiAnVkFMSURBVElPTl9FUlJPUicsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGJvZHkgPSBib2R5VmFsaWRhdGlvbi52YWx1ZVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0ZTogJ3ZhbGlkJyxcbiAgICAgIHJlcXVlc3RCb2R5OiBib2R5IGFzIFJlcUJvZHksXG4gICAgICByZXF1ZXN0UXVlcnlQYXJhbXM6IHF1ZXJ5UGFyYW1zIGFzIFJlcVF1ZXJ5UGFyYW1zLFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcGFyc2VBbmRWYWxpZGF0ZVJlc3BvbnNlKFxuICAgIGJvZHk6IFJlcyxcbiAgICBpZDogc3RyaW5nLFxuICAgIGxvZzogTG9nZ2VyXG4gICk6IFByb21pc2U8eyBzdGF0ZTogJ3ZhbGlkJzsgcmVzcG9uc2U6IFJlcyB9IHwgeyBzdGF0ZTogJ2ludmFsaWQnOyBlcnJvclJlc3BvbnNlOiBBUElHYXRld2F5UHJveHlSZXN1bHQgfT4ge1xuICAgIGNvbnN0IHJlc3BvbnNlU2NoZW1hID0gdGhpcy5yZXNwb25zZUJvZHlTY2hlbWEoKVxuXG4gICAgaWYgKCFyZXNwb25zZVNjaGVtYSkge1xuICAgICAgcmV0dXJuIHsgc3RhdGU6ICd2YWxpZCcsIHJlc3BvbnNlOiBib2R5IGFzIFJlcyB9XG4gICAgfVxuXG4gICAgY29uc3QgcmVzID0gcmVzcG9uc2VTY2hlbWEudmFsaWRhdGUoYm9keSwge1xuICAgICAgYWxsb3dVbmtub3duOiB0cnVlLFxuICAgICAgc3RyaXBVbmtub3duOiB0cnVlLCAvLyBFbnN1cmUgbm8gdW5leHBlY3RlZCBmaWVsZHMgcmV0dXJuZWQgdG8gdXNlcnMuXG4gICAgfSlcblxuICAgIGlmIChyZXMuZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihcbiAgICAgICAgeyBlcnJvcjogcmVzLmVycm9yPy5kZXRhaWxzLCBlcnJvcnM6IHJlcy5lcnJvcnM/LmRldGFpbHMsIGJvZHkgfSxcbiAgICAgICAgJ1VuZXhwZWN0ZWQgZXJyb3IuIFJlc3BvbnNlIGZhaWxlZCB2YWxpZGF0aW9uLidcbiAgICAgIClcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXRlOiAnaW52YWxpZCcsXG4gICAgICAgIGVycm9yUmVzcG9uc2U6IElOVEVSTkFMX0VSUk9SKGlkKSxcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBzdGF0ZTogJ3ZhbGlkJywgcmVzcG9uc2U6IHJlcy52YWx1ZSBhcyBSZXMgfVxuICB9XG59XG4iXX0=