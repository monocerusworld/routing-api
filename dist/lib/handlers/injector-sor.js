import { CachingGasStationProvider, CachingTokenListProvider, CachingTokenProviderWithFallback, CachingV3PoolProvider, ChainId, EIP1559GasPriceProvider, FallbackTenderlySimulator, TenderlySimulator, EthEstimateGasSimulator, LegacyGasPriceProvider, NodeJSCache, OnChainGasPriceProvider, OnChainQuoteProvider, setGlobalLogger, StaticV2SubgraphProvider, StaticV3SubgraphProvider, TokenProvider, UniswapMulticallProvider, V2PoolProvider, V2QuoteProvider, V3PoolProvider, } from '@tartz-one/smart-order-router';
import { default as bunyan } from 'bunyan';
import { ethers } from 'ethers';
import _ from 'lodash';
import NodeCache from 'node-cache';
import UNSUPPORTED_TOKEN_LIST from './../config/unsupported.tokenlist.json';
import { Injector } from './handler';
import { V2AWSSubgraphProvider, V3AWSSubgraphProvider } from './router-entities/aws-subgraph-provider';
import { AWSTokenListProvider } from './router-entities/aws-token-list-provider';
import { DynamoRouteCachingProvider } from './router-entities/route-caching/dynamo-route-caching-provider';
export const SUPPORTED_CHAINS = [
    ChainId.MAINNET,
    ChainId.RINKEBY,
    ChainId.ROPSTEN,
    ChainId.KOVAN,
    ChainId.OPTIMISM,
    ChainId.OPTIMISTIC_KOVAN,
    ChainId.ARBITRUM_ONE,
    ChainId.ARBITRUM_RINKEBY,
    ChainId.ARBITRUM_GOERLI,
    ChainId.POLYGON,
    ChainId.POLYGON_MUMBAI,
    ChainId.GÃ–RLI,
    ChainId.CELO,
    ChainId.CELO_ALFAJORES,
    ChainId.BSC,
    ChainId.FANTOM,
    ChainId.GNOSIS,
    ChainId.KLAYTN,
];
const DEFAULT_TOKEN_LIST = 'https://gateway.ipfs.io/ipns/tokens.uniswap.org';
export class InjectorSOR extends Injector {
    async buildContainerInjected() {
        const log = bunyan.createLogger({
            name: this.injectorName,
            serializers: bunyan.stdSerializers,
            level: bunyan.INFO,
        });
        setGlobalLogger(log);
        const { POOL_CACHE_BUCKET_2, POOL_CACHE_KEY, TOKEN_LIST_CACHE_BUCKET, CACHED_ROUTES_TABLE_NAME } = process.env;
        const dependenciesByChain = {};
        const dependenciesByChainArray = await Promise.all(_.map(SUPPORTED_CHAINS, async (chainId) => {
            const url = process.env[`WEB3_RPC_${chainId.toString()}`];
            if (!url) {
                log.fatal({ chainId: chainId }, `Fatal: No Web3 RPC endpoint set for chain`);
                return { chainId, dependencies: {} };
                // This router instance will not be able to route through any chain
                // for which RPC URL is not set
                // For now, if RPC URL is not set for a chain, a request to route
                // on the chain will return Err 500
            }
            let timeout;
            switch (chainId) {
                case ChainId.ARBITRUM_ONE:
                case ChainId.ARBITRUM_RINKEBY:
                    timeout = 8000;
                    break;
                default:
                    timeout = 5000;
                    break;
            }
            const provider = new ethers.providers.JsonRpcProvider({
                url: url,
                timeout,
            }, chainId);
            const tokenListProvider = await AWSTokenListProvider.fromTokenListS3Bucket(chainId, TOKEN_LIST_CACHE_BUCKET, DEFAULT_TOKEN_LIST);
            const tokenCache = new NodeJSCache(new NodeCache({ stdTTL: 3600, useClones: false }));
            const blockedTokenCache = new NodeJSCache(new NodeCache({ stdTTL: 3600, useClones: false }));
            const multicall2Provider = new UniswapMulticallProvider(chainId, provider, 375000);
            const tokenProvider = new CachingTokenProviderWithFallback(chainId, tokenCache, tokenListProvider, new TokenProvider(chainId, multicall2Provider));
            // Some providers like Infura set a gas limit per call of 10x block gas which is approx 150m
            // 200*725k < 150m
            let quoteProvider = undefined;
            switch (chainId) {
                case ChainId.OPTIMISM:
                case ChainId.OPTIMISTIC_KOVAN:
                    quoteProvider = new OnChainQuoteProvider(chainId, provider, multicall2Provider, {
                        retries: 2,
                        minTimeout: 100,
                        maxTimeout: 1000,
                    }, {
                        multicallChunk: 110,
                        gasLimitPerCall: 1200000,
                        quoteMinSuccessRate: 0.1,
                    }, {
                        gasLimitOverride: 3000000,
                        multicallChunk: 45,
                    }, {
                        gasLimitOverride: 3000000,
                        multicallChunk: 45,
                    }, {
                        baseBlockOffset: -25,
                        rollback: {
                            enabled: true,
                            attemptsBeforeRollback: 1,
                            rollbackBlockOffset: -20,
                        },
                    });
                    break;
                case ChainId.ARBITRUM_ONE:
                case ChainId.ARBITRUM_RINKEBY:
                    quoteProvider = new OnChainQuoteProvider(chainId, provider, multicall2Provider, {
                        retries: 2,
                        minTimeout: 100,
                        maxTimeout: 1000,
                    }, {
                        multicallChunk: 15,
                        gasLimitPerCall: 15000000,
                        quoteMinSuccessRate: 0.15,
                    }, {
                        gasLimitOverride: 30000000,
                        multicallChunk: 8,
                    }, {
                        gasLimitOverride: 30000000,
                        multicallChunk: 8,
                    }, {
                        baseBlockOffset: 0,
                        rollback: {
                            enabled: true,
                            attemptsBeforeRollback: 1,
                            rollbackBlockOffset: -10,
                        },
                    });
                    break;
            }
            const v3PoolProvider = new CachingV3PoolProvider(chainId, new V3PoolProvider(chainId, multicall2Provider), new NodeJSCache(new NodeCache({ stdTTL: 180, useClones: false })));
            const v2PoolProvider = new V2PoolProvider(chainId, multicall2Provider);
            const tenderlySimulator = new TenderlySimulator(chainId, 'http://api.tenderly.co', process.env.TENDERLY_USER, process.env.TENDERLY_PROJECT, process.env.TENDERLY_ACCESS_KEY, v2PoolProvider, v3PoolProvider, provider, { [ChainId.ARBITRUM_ONE]: 2.5 });
            const ethEstimateGasSimulator = new EthEstimateGasSimulator(chainId, provider, v2PoolProvider, v3PoolProvider);
            const simulator = new FallbackTenderlySimulator(chainId, provider, tenderlySimulator, ethEstimateGasSimulator);
            const [v3SubgraphProvider, v2SubgraphProvider] = await Promise.all([
                (async () => {
                    try {
                        const subgraphProvider = await V3AWSSubgraphProvider.EagerBuild(POOL_CACHE_BUCKET_2, POOL_CACHE_KEY, chainId);
                        return subgraphProvider;
                    }
                    catch (err) {
                        log.error({ err }, 'AWS Subgraph Provider unavailable, defaulting to Static Subgraph Provider');
                        return new StaticV3SubgraphProvider(chainId, v3PoolProvider);
                    }
                })(),
                (async () => {
                    try {
                        const subgraphProvider = await V2AWSSubgraphProvider.EagerBuild(POOL_CACHE_BUCKET_2, POOL_CACHE_KEY, chainId);
                        return subgraphProvider;
                    }
                    catch (err) {
                        return new StaticV2SubgraphProvider(chainId);
                    }
                })(),
            ]);
            let routeCachingProvider = undefined;
            if (CACHED_ROUTES_TABLE_NAME && CACHED_ROUTES_TABLE_NAME !== '') {
                routeCachingProvider = new DynamoRouteCachingProvider({ cachedRoutesTableName: CACHED_ROUTES_TABLE_NAME });
            }
            return {
                chainId,
                dependencies: {
                    provider,
                    tokenListProvider: await AWSTokenListProvider.fromTokenListS3Bucket(chainId, TOKEN_LIST_CACHE_BUCKET, DEFAULT_TOKEN_LIST),
                    blockedTokenListProvider: await CachingTokenListProvider.fromTokenList(chainId, UNSUPPORTED_TOKEN_LIST, blockedTokenCache),
                    multicallProvider: multicall2Provider,
                    tokenProvider,
                    tokenProviderFromTokenList: tokenListProvider,
                    gasPriceProvider: new CachingGasStationProvider(chainId, new OnChainGasPriceProvider(chainId, new EIP1559GasPriceProvider(provider), new LegacyGasPriceProvider(provider)), new NodeJSCache(new NodeCache({ stdTTL: 15, useClones: false }))),
                    v3SubgraphProvider,
                    onChainQuoteProvider: quoteProvider,
                    v3PoolProvider,
                    v2PoolProvider,
                    v2QuoteProvider: new V2QuoteProvider(),
                    v2SubgraphProvider,
                    simulator,
                    routeCachingProvider,
                },
            };
        }));
        for (const { chainId, dependencies } of dependenciesByChainArray) {
            dependenciesByChain[chainId] = dependencies;
        }
        return {
            dependencies: dependenciesByChain,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0b3Itc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2hhbmRsZXJzL2luamVjdG9yLXNvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wseUJBQXlCLEVBQ3pCLHdCQUF3QixFQUN4QixnQ0FBZ0MsRUFDaEMscUJBQXFCLEVBQ3JCLE9BQU8sRUFDUCx1QkFBdUIsRUFDdkIseUJBQXlCLEVBQ3pCLGlCQUFpQixFQUNqQix1QkFBdUIsRUFVdkIsc0JBQXNCLEVBQ3RCLFdBQVcsRUFDWCx1QkFBdUIsRUFDdkIsb0JBQW9CLEVBQ3BCLGVBQWUsRUFDZix3QkFBd0IsRUFDeEIsd0JBQXdCLEVBQ3hCLGFBQWEsRUFDYix3QkFBd0IsRUFDeEIsY0FBYyxFQUNkLGVBQWUsRUFDZixjQUFjLEdBRWYsTUFBTSwrQkFBK0IsQ0FBQTtBQUV0QyxPQUFPLEVBQUUsT0FBTyxJQUFJLE1BQU0sRUFBcUIsTUFBTSxRQUFRLENBQUE7QUFDN0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFFBQVEsQ0FBQTtBQUMvQixPQUFPLENBQUMsTUFBTSxRQUFRLENBQUE7QUFDdEIsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFBO0FBQ2xDLE9BQU8sc0JBQXNCLE1BQU0sd0NBQXdDLENBQUE7QUFDM0UsT0FBTyxFQUFZLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQTtBQUM5QyxPQUFPLEVBQUUscUJBQXFCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQTtBQUN0RyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQTtBQUNoRixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwrREFBK0QsQ0FBQTtBQUUxRyxNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBYztJQUN6QyxPQUFPLENBQUMsT0FBTztJQUNmLE9BQU8sQ0FBQyxPQUFPO0lBQ2YsT0FBTyxDQUFDLE9BQU87SUFDZixPQUFPLENBQUMs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LENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRva2VuIH0gZnJvbSAnQHVuaXN3YXAvc2RrLWNvcmUnXG5pbXBvcnQge1xuICBDYWNoaW5nR2FzU3RhdGlvblByb3ZpZGVyLFxuICBDYWNoaW5nVG9rZW5MaXN0UHJvdmlkZXIsXG4gIENhY2hpbmdUb2tlblByb3ZpZGVyV2l0aEZhbGxiYWNrLFxuICBDYWNoaW5nVjNQb29sUHJvdmlkZXIsXG4gIENoYWluSWQsXG4gIEVJUDE1NTlHYXNQcmljZVByb3ZpZGVyLFxuICBGYWxsYmFja1RlbmRlcmx5U2ltdWxhdG9yLFxuICBUZW5kZXJseVNpbXVsYXRvcixcbiAgRXRoRXN0aW1hdGVHYXNTaW11bGF0b3IsXG4gIElHYXNQcmljZVByb3ZpZGVyLFxuICBJTWV0cmljLFxuICBTaW11bGF0b3IsXG4gIElUb2tlbkxpc3RQcm92aWRlcixcbiAgSVRva2VuUHJvdmlkZXIsXG4gIElWMlBvb2xQcm92aWRlcixcbiAgSVYyU3ViZ3JhcGhQcm92aWRlcixcbiAgSVYzUG9vbFByb3ZpZGVyLFxuICBJVjNTdWJncmFwaFByb3ZpZGVyLFxuICBMZWdhY3lHYXNQcmljZVByb3ZpZGVyLFxuICBOb2RlSlNDYWNoZSxcbiAgT25DaGFpbkdhc1ByaWNlUHJvdmlkZXIsXG4gIE9uQ2hhaW5RdW90ZVByb3ZpZGVyLFxuICBzZXRHbG9iYWxMb2dnZXIsXG4gIFN0YXRpY1YyU3ViZ3JhcGhQcm92aWRlcixcbiAgU3RhdGljVjNTdWJncmFwaFByb3ZpZGVyLFxuICBUb2tlblByb3ZpZGVyLFxuICBVbmlzd2FwTXVsdGljYWxsUHJvdmlkZXIsXG4gIFYyUG9vbFByb3ZpZGVyLFxuICBWMlF1b3RlUHJvdmlkZXIsXG4gIFYzUG9vbFByb3ZpZGVyLFxuICBJUm91dGVDYWNoaW5nUHJvdmlkZXIsXG59IGZyb20gJ0B0YXJ0ei1vbmUvc21hcnQtb3JkZXItcm91dGVyJ1xuaW1wb3J0IHsgVG9rZW5MaXN0IH0gZnJvbSAnQHVuaXN3YXAvdG9rZW4tbGlzdHMnXG5pbXBvcnQgeyBkZWZhdWx0IGFzIGJ1bnlhbiwgZGVmYXVsdCBhcyBMb2dnZXIgfSBmcm9tICdidW55YW4nXG5pbXBvcnQgeyBldGhlcnMgfSBmcm9tICdldGhlcnMnXG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnXG5pbXBvcnQgTm9kZUNhY2hlIGZyb20gJ25vZGUtY2FjaGUnXG5pbXBvcnQgVU5TVVBQT1JURURfVE9LRU5fTElTVCBmcm9tICcuLy4uL2NvbmZpZy91bnN1cHBvcnRlZC50b2tlbmxpc3QuanNvbidcbmltcG9ydCB7IEJhc2VSSW5qLCBJbmplY3RvciB9IGZyb20gJy4vaGFuZGxlcidcbmltcG9ydCB7IFYyQVdTU3ViZ3JhcGhQcm92aWRlciwgVjNBV1NTdWJncmFwaFByb3ZpZGVyIH0gZnJvbSAnLi9yb3V0ZXItZW50aXRpZXMvYXdzLXN1YmdyYXBoLXByb3ZpZGVyJ1xuaW1wb3J0IHsgQVdTVG9rZW5MaXN0UHJvdmlkZXIgfSBmcm9tICcuL3JvdXRlci1lbnRpdGllcy9hd3MtdG9rZW4tbGlzdC1wcm92aWRlcidcbmltcG9ydCB7IER5bmFtb1JvdXRlQ2FjaGluZ1Byb3ZpZGVyIH0gZnJvbSAnLi9yb3V0ZXItZW50aXRpZXMvcm91dGUtY2FjaGluZy9keW5hbW8tcm91dGUtY2FjaGluZy1wcm92aWRlcidcblxuZXhwb3J0IGNvbnN0IFNVUFBPUlRFRF9DSEFJTlM6IENoYWluSWRbXSA9IFtcbiAgQ2hhaW5JZC5NQUlOTkVULFxuICBDaGFpbklkLlJJTktFQlksXG4gIENoYWluSWQuUk9QU1RFTixcbiAgQ2hhaW5JZC5LT1ZBTixcbiAgQ2hhaW5JZC5PUFRJTUlTTSxcbiAgQ2hhaW5JZC5PUFRJTUlTVElDX0tPVkFOLFxuICBDaGFpbklkLkFSQklUUlVNX09ORSxcbiAgQ2hhaW5JZC5BUkJJVFJVTV9SSU5LRUJZLFxuICBDaGFpbklkLkFSQklUUlVNX0dPRVJMSSxcbiAgQ2hhaW5JZC5QT0xZR09OLFxuICBDaGFpbklkLlBPTFlHT05fTVVNQkFJLFxuICBDaGFpbklkLkfDllJMSSxcbiAgQ2hhaW5JZC5DRUxPLFxuICBDaGFpbklkLkNFTE9fQUxGQUpPUkVTLFxuICBDaGFpbklkLkJTQyxcbiAgQ2hhaW5JZC5GQU5UT00sXG4gIENoYWluSWQuR05PU0lTLFxuICBDaGFpbklkLktMQVlUTixcblxuXVxuY29uc3QgREVGQVVMVF9UT0tFTl9MSVNUID0gJ2h0dHBzOi8vZ2F0ZXdheS5pcGZzLmlvL2lwbnMvdG9rZW5zLnVuaXN3YXAub3JnJ1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlcXVlc3RJbmplY3RlZDxSb3V0ZXI+IGV4dGVuZHMgQmFzZVJJbmoge1xuICBjaGFpbklkOiBDaGFpbklkXG4gIG1ldHJpYzogSU1ldHJpY1xuICB2M1Bvb2xQcm92aWRlcjogSVYzUG9vbFByb3ZpZGVyXG4gIHYyUG9vbFByb3ZpZGVyOiBJVjJQb29sUHJvdmlkZXJcbiAgdG9rZW5Qcm92aWRlcjogSVRva2VuUHJvdmlkZXJcbiAgdG9rZW5MaXN0UHJvdmlkZXI6IElUb2tlbkxpc3RQcm92aWRlclxuICByb3V0ZXI6IFJvdXRlclxufVxuXG5leHBvcnQgdHlwZSBDb250YWluZXJEZXBlbmRlbmNpZXMgPSB7XG4gIHByb3ZpZGVyOiBldGhlcnMucHJvdmlkZXJzLkpzb25ScGNQcm92aWRlclxuICB2M1N1YmdyYXBoUHJvdmlkZXI6IElWM1N1YmdyYXBoUHJvdmlkZXJcbiAgdjJTdWJncmFwaFByb3ZpZGVyOiBJVjJTdWJncmFwaFByb3ZpZGVyXG4gIHRva2VuTGlzdFByb3ZpZGVyOiBJVG9rZW5MaXN0UHJvdmlkZXJcbiAgZ2FzUHJpY2VQcm92aWRlcjogSUdhc1ByaWNlUHJvdmlkZXJcbiAgdG9rZW5Qcm92aWRlckZyb21Ub2tlbkxpc3Q6IElUb2tlblByb3ZpZGVyXG4gIGJsb2NrZWRUb2tlbkxpc3RQcm92aWRlcjogSVRva2VuTGlzdFByb3ZpZGVyXG4gIHYzUG9vbFByb3ZpZGVyOiBJVjNQb29sUHJvdmlkZXJcbiAgdjJQb29sUHJvdmlkZXI6IElWMlBvb2xQcm92aWRlclxuICB0b2tlblByb3ZpZGVyOiBJVG9rZW5Qcm92aWRlclxuICBtdWx0aWNhbGxQcm92aWRlcjogVW5pc3dhcE11bHRpY2FsbFByb3ZpZGVyXG4gIG9uQ2hhaW5RdW90ZVByb3ZpZGVyPzogT25DaGFpblF1b3RlUHJvdmlkZXJcbiAgdjJRdW90ZVByb3ZpZGVyOiBWMlF1b3RlUHJvdmlkZXJcbiAgc2ltdWxhdG9yOiBTaW11bGF0b3JcbiAgcm91dGVDYWNoaW5nUHJvdmlkZXI/OiBJUm91dGVDYWNoaW5nUHJvdmlkZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb250YWluZXJJbmplY3RlZCB7XG4gIGRlcGVuZGVuY2llczoge1xuICAgIFtjaGFpbklkIGluIENoYWluSWRdPzogQ29udGFpbmVyRGVwZW5kZW5jaWVzXG4gIH1cbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEluamVjdG9yU09SPFJvdXRlciwgUXVlcnlQYXJhbXM+IGV4dGVuZHMgSW5qZWN0b3I8XG4gIENvbnRhaW5lckluamVjdGVkLFxuICBSZXF1ZXN0SW5qZWN0ZWQ8Um91dGVyPixcbiAgdm9pZCxcbiAgUXVlcnlQYXJhbXNcbj4ge1xuICBwdWJsaWMgYXN5bmMgYnVpbGRDb250YWluZXJJbmplY3RlZCgpOiBQcm9taXNlPENvbnRhaW5lckluamVjdGVkPiB7XG4gICAgY29uc3QgbG9nOiBMb2dnZXIgPSBidW55YW4uY3JlYXRlTG9nZ2VyKHtcbiAgICAgIG5hbWU6IHRoaXMuaW5qZWN0b3JOYW1lLFxuICAgICAgc2VyaWFsaXplcnM6IGJ1bnlhbi5zdGRTZXJpYWxpemVycyxcbiAgICAgIGxldmVsOiBidW55YW4uSU5GTyxcbiAgICB9KVxuICAgIHNldEdsb2JhbExvZ2dlcihsb2cpXG5cbiAgICBjb25zdCB7IFBPT0xfQ0FDSEVfQlVDS0VUXzIsIFBPT0xfQ0FDSEVfS0VZLCBUT0tFTl9MSVNUX0NBQ0hFX0JVQ0tFVCwgQ0FDSEVEX1JPVVRFU19UQUJMRV9OQU1FIH0gPSBwcm9jZXNzLmVudlxuXG4gICAgY29uc3QgZGVwZW5kZW5jaWVzQnlDaGFpbjoge1xuICAgICAgW2NoYWluSWQgaW4gQ2hhaW5JZF0/OiBDb250YWluZXJEZXBlbmRlbmNpZXNcbiAgICB9ID0ge31cblxuICAgIGNvbnN0IGRlcGVuZGVuY2llc0J5Q2hhaW5BcnJheSA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgXy5tYXAoU1VQUE9SVEVEX0NIQUlOUywgYXN5bmMgKGNoYWluSWQ6IENoYWluSWQpID0+IHtcbiAgICAgICAgY29uc3QgdXJsID0gcHJvY2Vzcy5lbnZbYFdFQjNfUlBDXyR7Y2hhaW5JZC50b1N0cmluZygpfWBdIVxuXG4gICAgICAgIGlmICghdXJsKSB7XG4gICAgICAgICAgbG9nLmZhdGFsKHsgY2hhaW5JZDogY2hhaW5JZCB9LCBgRmF0YWw6IE5vIFdlYjMgUlBDIGVuZHBvaW50IHNldCBmb3IgY2hhaW5gKVxuICAgICAgICAgIHJldHVybiB7IGNoYWluSWQsIGRlcGVuZGVuY2llczoge30gYXMgQ29udGFpbmVyRGVwZW5kZW5jaWVzIH1cbiAgICAgICAgICAvLyBUaGlzIHJvdXRlciBpbnN0YW5jZSB3aWxsIG5vdCBiZSBhYmxlIHRvIHJvdXRlIHRocm91Z2ggYW55IGNoYWluXG4gICAgICAgICAgLy8gZm9yIHdoaWNoIFJQQyBVUkwgaXMgbm90IHNldFxuICAgICAgICAgIC8vIEZvciBub3csIGlmIFJQQyBVUkwgaXMgbm90IHNldCBmb3IgYSBjaGFpbiwgYSByZXF1ZXN0IHRvIHJvdXRlXG4gICAgICAgICAgLy8gb24gdGhlIGNoYWluIHdpbGwgcmV0dXJuIEVyciA1MDBcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB0aW1lb3V0OiBudW1iZXJcbiAgICAgICAgc3dpdGNoIChjaGFpbklkKSB7XG4gICAgICAgICAgY2FzZSBDaGFpbklkLkFSQklUUlVNX09ORTpcbiAgICAgICAgICBjYXNlIENoYWluSWQuQVJCSVRSVU1fUklOS0VCWTpcbiAgICAgICAgICAgIHRpbWVvdXQgPSA4MDAwXG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICB0aW1lb3V0ID0gNTAwMFxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByb3ZpZGVyID0gbmV3IGV0aGVycy5wcm92aWRlcnMuSnNvblJwY1Byb3ZpZGVyKFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgdGltZW91dCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNoYWluSWRcbiAgICAgICAgKVxuXG4gICAgICAgIGNvbnN0IHRva2VuTGlzdFByb3ZpZGVyID0gYXdhaXQgQVdTVG9rZW5MaXN0UHJvdmlkZXIuZnJvbVRva2VuTGlzdFMzQnVja2V0KFxuICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgVE9LRU5fTElTVF9DQUNIRV9CVUNLRVQhLFxuICAgICAgICAgIERFRkFVTFRfVE9LRU5fTElTVFxuICAgICAgICApXG5cbiAgICAgICAgY29uc3QgdG9rZW5DYWNoZSA9IG5ldyBOb2RlSlNDYWNoZTxUb2tlbj4obmV3IE5vZGVDYWNoZSh7IHN0ZFRUTDogMzYwMCwgdXNlQ2xvbmVzOiBmYWxzZSB9KSlcbiAgICAgICAgY29uc3QgYmxvY2tlZFRva2VuQ2FjaGUgPSBuZXcgTm9kZUpTQ2FjaGU8VG9rZW4+KG5ldyBOb2RlQ2FjaGUoeyBzdGRUVEw6IDM2MDAsIHVzZUNsb25lczogZmFsc2UgfSkpXG5cbiAgICAgICAgY29uc3QgbXVsdGljYWxsMlByb3ZpZGVyID0gbmV3IFVuaXN3YXBNdWx0aWNhbGxQcm92aWRlcihjaGFpbklkLCBwcm92aWRlciwgMzc1XzAwMClcbiAgICAgICAgY29uc3QgdG9rZW5Qcm92aWRlciA9IG5ldyBDYWNoaW5nVG9rZW5Qcm92aWRlcldpdGhGYWxsYmFjayhcbiAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgIHRva2VuQ2FjaGUsXG4gICAgICAgICAgdG9rZW5MaXN0UHJvdmlkZXIsXG4gICAgICAgICAgbmV3IFRva2VuUHJvdmlkZXIoY2hhaW5JZCwgbXVsdGljYWxsMlByb3ZpZGVyKVxuICAgICAgICApXG5cbiAgICAgICAgLy8gU29tZSBwcm92aWRlcnMgbGlrZSBJbmZ1cmEgc2V0IGEgZ2FzIGxpbWl0IHBlciBjYWxsIG9mIDEweCBibG9jayBnYXMgd2hpY2ggaXMgYXBwcm94IDE1MG1cbiAgICAgICAgLy8gMjAwKjcyNWsgPCAxNTBtXG4gICAgICAgIGxldCBxdW90ZVByb3ZpZGVyOiBPbkNoYWluUXVvdGVQcm92aWRlciB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZFxuICAgICAgICBzd2l0Y2ggKGNoYWluSWQpIHtcbiAgICAgICAgICBjYXNlIENoYWluSWQuT1BUSU1JU006XG4gICAgICAgICAgY2FzZSBDaGFpbklkLk9QVElNSVNUSUNfS09WQU46XG4gICAgICAgICAgICBxdW90ZVByb3ZpZGVyID0gbmV3IE9uQ2hhaW5RdW90ZVByb3ZpZGVyKFxuICAgICAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgICAgICBwcm92aWRlcixcbiAgICAgICAgICAgICAgbXVsdGljYWxsMlByb3ZpZGVyLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcmV0cmllczogMixcbiAgICAgICAgICAgICAgICBtaW5UaW1lb3V0OiAxMDAsXG4gICAgICAgICAgICAgICAgbWF4VGltZW91dDogMTAwMCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG11bHRpY2FsbENodW5rOiAxMTAsXG4gICAgICAgICAgICAgICAgZ2FzTGltaXRQZXJDYWxsOiAxXzIwMF8wMDAsXG4gICAgICAgICAgICAgICAgcXVvdGVNaW5TdWNjZXNzUmF0ZTogMC4xLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZ2FzTGltaXRPdmVycmlkZTogM18wMDBfMDAwLFxuICAgICAgICAgICAgICAgIG11bHRpY2FsbENodW5rOiA0NSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGdhc0xpbWl0T3ZlcnJpZGU6IDNfMDAwXzAwMCxcbiAgICAgICAgICAgICAgICBtdWx0aWNhbGxDaHVuazogNDUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBiYXNlQmxvY2tPZmZzZXQ6IC0yNSxcbiAgICAgICAgICAgICAgICByb2xsYmFjazoge1xuICAgICAgICAgICAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGF0dGVtcHRzQmVmb3JlUm9sbGJhY2s6IDEsXG4gICAgICAgICAgICAgICAgICByb2xsYmFja0Jsb2NrT2Zmc2V0OiAtMjAsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICBjYXNlIENoYWluSWQuQVJCSVRSVU1fT05FOlxuICAgICAgICAgIGNhc2UgQ2hhaW5JZC5BUkJJVFJVTV9SSU5LRUJZOlxuICAgICAgICAgICAgcXVvdGVQcm92aWRlciA9IG5ldyBPbkNoYWluUXVvdGVQcm92aWRlcihcbiAgICAgICAgICAgICAgY2hhaW5JZCxcbiAgICAgICAgICAgICAgcHJvdmlkZXIsXG4gICAgICAgICAgICAgIG11bHRpY2FsbDJQcm92aWRlcixcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHJldHJpZXM6IDIsXG4gICAgICAgICAgICAgICAgbWluVGltZW91dDogMTAwLFxuICAgICAgICAgICAgICAgIG1heFRpbWVvdXQ6IDEwMDAsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtdWx0aWNhbGxDaHVuazogMTUsXG4gICAgICAgICAgICAgICAgZ2FzTGltaXRQZXJDYWxsOiAxNV8wMDBfMDAwLFxuICAgICAgICAgICAgICAgIHF1b3RlTWluU3VjY2Vzc1JhdGU6IDAuMTUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBnYXNMaW1pdE92ZXJyaWRlOiAzMF8wMDBfMDAwLFxuICAgICAgICAgICAgICAgIG11bHRpY2FsbENodW5rOiA4LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZ2FzTGltaXRPdmVycmlkZTogMzBfMDAwXzAwMCxcbiAgICAgICAgICAgICAgICBtdWx0aWNhbGxDaHVuazogOCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGJhc2VCbG9ja09mZnNldDogMCxcbiAgICAgICAgICAgICAgICByb2xsYmFjazoge1xuICAgICAgICAgICAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGF0dGVtcHRzQmVmb3JlUm9sbGJhY2s6IDEsXG4gICAgICAgICAgICAgICAgICByb2xsYmFja0Jsb2NrT2Zmc2V0OiAtMTAsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHYzUG9vbFByb3ZpZGVyID0gbmV3IENhY2hpbmdWM1Bvb2xQcm92aWRlcihcbiAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgIG5ldyBWM1Bvb2xQcm92aWRlcihjaGFpbklkLCBtdWx0aWNhbGwyUHJvdmlkZXIpLFxuICAgICAgICAgIG5ldyBOb2RlSlNDYWNoZShuZXcgTm9kZUNhY2hlKHsgc3RkVFRMOiAxODAsIHVzZUNsb25lczogZmFsc2UgfSkpXG4gICAgICAgIClcblxuICAgICAgICBjb25zdCB2MlBvb2xQcm92aWRlciA9IG5ldyBWMlBvb2xQcm92aWRlcihjaGFpbklkLCBtdWx0aWNhbGwyUHJvdmlkZXIpXG5cbiAgICAgICAgY29uc3QgdGVuZGVybHlTaW11bGF0b3IgPSBuZXcgVGVuZGVybHlTaW11bGF0b3IoXG4gICAgICAgICAgY2hhaW5JZCxcbiAgICAgICAgICAnaHR0cDovL2FwaS50ZW5kZXJseS5jbycsXG4gICAgICAgICAgcHJvY2Vzcy5lbnYuVEVOREVSTFlfVVNFUiEsXG4gICAgICAgICAgcHJvY2Vzcy5lbnYuVEVOREVSTFlfUFJPSkVDVCEsXG4gICAgICAgICAgcHJvY2Vzcy5lbnYuVEVOREVSTFlfQUNDRVNTX0tFWSEsXG4gICAgICAgICAgdjJQb29sUHJvdmlkZXIsXG4gICAgICAgICAgdjNQb29sUHJvdmlkZXIsXG4gICAgICAgICAgcHJvdmlkZXIsXG4gICAgICAgICAgeyBbQ2hhaW5JZC5BUkJJVFJVTV9PTkVdOiAyLjUgfVxuICAgICAgICApXG5cbiAgICAgICAgY29uc3QgZXRoRXN0aW1hdGVHYXNTaW11bGF0b3IgPSBuZXcgRXRoRXN0aW1hdGVHYXNTaW11bGF0b3IoY2hhaW5JZCwgcHJvdmlkZXIsIHYyUG9vbFByb3ZpZGVyLCB2M1Bvb2xQcm92aWRlcilcblxuICAgICAgICBjb25zdCBzaW11bGF0b3IgPSBuZXcgRmFsbGJhY2tUZW5kZXJseVNpbXVsYXRvcihjaGFpbklkLCBwcm92aWRlciwgdGVuZGVybHlTaW11bGF0b3IsIGV0aEVzdGltYXRlR2FzU2ltdWxhdG9yKVxuXG4gICAgICAgIGNvbnN0IFt2M1N1YmdyYXBoUHJvdmlkZXIsIHYyU3ViZ3JhcGhQcm92aWRlcl0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGNvbnN0IHN1YmdyYXBoUHJvdmlkZXIgPSBhd2FpdCBWM0FXU1N1YmdyYXBoUHJvdmlkZXIuRWFnZXJCdWlsZChcbiAgICAgICAgICAgICAgICBQT09MX0NBQ0hFX0JVQ0tFVF8yISxcbiAgICAgICAgICAgICAgICBQT09MX0NBQ0hFX0tFWSEsXG4gICAgICAgICAgICAgICAgY2hhaW5JZFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIHJldHVybiBzdWJncmFwaFByb3ZpZGVyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgbG9nLmVycm9yKHsgZXJyIH0sICdBV1MgU3ViZ3JhcGggUHJvdmlkZXIgdW5hdmFpbGFibGUsIGRlZmF1bHRpbmcgdG8gU3RhdGljIFN1YmdyYXBoIFByb3ZpZGVyJylcbiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBTdGF0aWNWM1N1YmdyYXBoUHJvdmlkZXIoY2hhaW5JZCwgdjNQb29sUHJvdmlkZXIpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSkoKSxcbiAgICAgICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgY29uc3Qgc3ViZ3JhcGhQcm92aWRlciA9IGF3YWl0IFYyQVdTU3ViZ3JhcGhQcm92aWRlci5FYWdlckJ1aWxkKFxuICAgICAgICAgICAgICAgIFBPT0xfQ0FDSEVfQlVDS0VUXzIhLFxuICAgICAgICAgICAgICAgIFBPT0xfQ0FDSEVfS0VZISxcbiAgICAgICAgICAgICAgICBjaGFpbklkXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgcmV0dXJuIHN1YmdyYXBoUHJvdmlkZXJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICByZXR1cm4gbmV3IFN0YXRpY1YyU3ViZ3JhcGhQcm92aWRlcihjaGFpbklkKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pKCksXG4gICAgICAgIF0pXG5cbiAgICAgICAgbGV0IHJvdXRlQ2FjaGluZ1Byb3ZpZGVyOiBJUm91dGVDYWNoaW5nUHJvdmlkZXIgfCB1bmRlZmluZWQgPSB1bmRlZmluZWRcbiAgICAgICAgaWYgKENBQ0hFRF9ST1VURVNfVEFCTEVfTkFNRSAmJiBDQUNIRURfUk9VVEVTX1RBQkxFX05BTUUgIT09ICcnKSB7XG4gICAgICAgICAgcm91dGVDYWNoaW5nUHJvdmlkZXIgPSBuZXcgRHluYW1vUm91dGVDYWNoaW5nUHJvdmlkZXIoeyBjYWNoZWRSb3V0ZXNUYWJsZU5hbWU6IENBQ0hFRF9ST1VURVNfVEFCTEVfTkFNRSB9KVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgIGRlcGVuZGVuY2llczoge1xuICAgICAgICAgICAgcHJvdmlkZXIsXG4gICAgICAgICAgICB0b2tlbkxpc3RQcm92aWRlcjogYXdhaXQgQVdTVG9rZW5MaXN0UHJvdmlkZXIuZnJvbVRva2VuTGlzdFMzQnVja2V0KFxuICAgICAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgICAgICBUT0tFTl9MSVNUX0NBQ0hFX0JVQ0tFVCEsXG4gICAgICAgICAgICAgIERFRkFVTFRfVE9LRU5fTElTVFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGJsb2NrZWRUb2tlbkxpc3RQcm92aWRlcjogYXdhaXQgQ2FjaGluZ1Rva2VuTGlzdFByb3ZpZGVyLmZyb21Ub2tlbkxpc3QoXG4gICAgICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgICAgIFVOU1VQUE9SVEVEX1RPS0VOX0xJU1QgYXMgVG9rZW5MaXN0LFxuICAgICAgICAgICAgICBibG9ja2VkVG9rZW5DYWNoZVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIG11bHRpY2FsbFByb3ZpZGVyOiBtdWx0aWNhbGwyUHJvdmlkZXIsXG4gICAgICAgICAgICB0b2tlblByb3ZpZGVyLFxuICAgICAgICAgICAgdG9rZW5Qcm92aWRlckZyb21Ub2tlbkxpc3Q6IHRva2VuTGlzdFByb3ZpZGVyLFxuICAgICAgICAgICAgZ2FzUHJpY2VQcm92aWRlcjogbmV3IENhY2hpbmdHYXNTdGF0aW9uUHJvdmlkZXIoXG4gICAgICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgICAgIG5ldyBPbkNoYWluR2FzUHJpY2VQcm92aWRlcihcbiAgICAgICAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgICAgICAgIG5ldyBFSVAxNTU5R2FzUHJpY2VQcm92aWRlcihwcm92aWRlciksXG4gICAgICAgICAgICAgICAgbmV3IExlZ2FjeUdhc1ByaWNlUHJvdmlkZXIocHJvdmlkZXIpXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgIG5ldyBOb2RlSlNDYWNoZShuZXcgTm9kZUNhY2hlKHsgc3RkVFRMOiAxNSwgdXNlQ2xvbmVzOiBmYWxzZSB9KSlcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICB2M1N1YmdyYXBoUHJvdmlkZXIsXG4gICAgICAgICAgICBvbkNoYWluUXVvdGVQcm92aWRlcjogcXVvdGVQcm92aWRlcixcbiAgICAgICAgICAgIHYzUG9vbFByb3ZpZGVyLFxuICAgICAgICAgICAgdjJQb29sUHJvdmlkZXIsXG4gICAgICAgICAgICB2MlF1b3RlUHJvdmlkZXI6IG5ldyBWMlF1b3RlUHJvdmlkZXIoKSxcbiAgICAgICAgICAgIHYyU3ViZ3JhcGhQcm92aWRlcixcbiAgICAgICAgICAgIHNpbXVsYXRvcixcbiAgICAgICAgICAgIHJvdXRlQ2FjaGluZ1Byb3ZpZGVyLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKVxuXG4gICAgZm9yIChjb25zdCB7IGNoYWluSWQsIGRlcGVuZGVuY2llcyB9IG9mIGRlcGVuZGVuY2llc0J5Q2hhaW5BcnJheSkge1xuICAgICAgZGVwZW5kZW5jaWVzQnlDaGFpbltjaGFpbklkXSA9IGRlcGVuZGVuY2llc1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBkZXBlbmRlbmNpZXM6IGRlcGVuZGVuY2llc0J5Q2hhaW4sXG4gICAgfVxuICB9XG59XG4iXX0=