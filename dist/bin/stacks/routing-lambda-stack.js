import * as cdk from 'aws-cdk-lib';
import { Duration } from 'aws-cdk-lib';
import * as asg from 'aws-cdk-lib/aws-applicationautoscaling';
import * as aws_cloudwatch from 'aws-cdk-lib/aws-cloudwatch';
import * as aws_cloudwatch_actions from 'aws-cdk-lib/aws-cloudwatch-actions';
import * as aws_iam from 'aws-cdk-lib/aws-iam';
import * as aws_lambda from 'aws-cdk-lib/aws-lambda';
import * as aws_lambda_nodejs from 'aws-cdk-lib/aws-lambda-nodejs';
import * as aws_sns from 'aws-cdk-lib/aws-sns';
import * as path from 'path';
export class RoutingLambdaStack extends cdk.NestedStack {
    constructor(scope, name, props) {
        var _a, _b;
        super(scope, name, props);
        const { poolCacheBucket, poolCacheBucket2, poolCacheKey, jsonRpcProviders, tokenListCacheBucket, provisionedConcurrency, ethGasStationInfoUrl, chatbotSNSArn, tenderlyUser, tenderlyProject, tenderlyAccessKey, cachedRoutesDynamoDb, } = props;
        const lambdaRole = new aws_iam.Role(this, 'RoutingLambdaRole', {
            assumedBy: new aws_iam.ServicePrincipal('lambda.amazonaws.com'),
            managedPolicies: [
                aws_iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSLambdaBasicExecutionRole'),
                aws_iam.ManagedPolicy.fromAwsManagedPolicyName('CloudWatchLambdaInsightsExecutionRolePolicy'),
                aws_iam.ManagedPolicy.fromAwsManagedPolicyName('AWSXRayDaemonWriteAccess'),
            ],
        });
        poolCacheBucket.grantRead(lambdaRole);
        poolCacheBucket2.grantRead(lambdaRole);
        tokenListCacheBucket.grantRead(lambdaRole);
        cachedRoutesDynamoDb === null || cachedRoutesDynamoDb === void 0 ? void 0 : cachedRoutesDynamoDb.grantReadWriteData(lambdaRole);
        const region = cdk.Stack.of(this).region;
        this.routingLambda = new aws_lambda_nodejs.NodejsFunction(this, 'RoutingLambda2', {
            role: lambdaRole,
            runtime: aws_lambda.Runtime.NODEJS_14_X,
            entry: path.join(__dirname, '../../lib/handlers/index.ts'),
            handler: 'quoteHandler',
            timeout: cdk.Duration.seconds(29),
            memorySize: 1024,
            bundling: {
                minify: true,
                sourceMap: true,
            },
            description: 'Routing Lambda',
            environment: {
                VERSION: '5',
                NODE_OPTIONS: '--enable-source-maps',
                POOL_CACHE_BUCKET: poolCacheBucket.bucketName,
                POOL_CACHE_BUCKET_2: poolCacheBucket2.bucketName,
                POOL_CACHE_KEY: poolCacheKey,
                TOKEN_LIST_CACHE_BUCKET: tokenListCacheBucket.bucketName,
                ETH_GAS_STATION_INFO_URL: ethGasStationInfoUrl,
                TENDERLY_USER: tenderlyUser,
                TENDERLY_PROJECT: tenderlyProject,
                TENDERLY_ACCESS_KEY: tenderlyAccessKey,
                CACHED_ROUTES_TABLE_NAME: (_a = cachedRoutesDynamoDb === null || cachedRoutesDynamoDb === void 0 ? void 0 : cachedRoutesDynamoDb.tableName) !== null && _a !== void 0 ? _a : '',
                ...jsonRpcProviders,
            },
            layers: [
                aws_lambda.LayerVersion.fromLayerVersionArn(this, 'InsightsLayer', `arn:aws:lambda:${region}:580247275435:layer:LambdaInsightsExtension:14`),
            ],
            tracing: aws_lambda.Tracing.ACTIVE,
        });
        this.routeToRatioLambda = new aws_lambda_nodejs.NodejsFunction(this, 'RouteToRatioLambda2', {
            role: lambdaRole,
            runtime: aws_lambda.Runtime.NODEJS_14_X,
            entry: path.join(__dirname, '../../lib/handlers/index.ts'),
            handler: 'quoteToRatioHandler',
            timeout: cdk.Duration.seconds(29),
            memorySize: 1024,
            bundling: {
                minify: true,
                sourceMap: true,
            },
            description: 'Route to Ratio Lambda',
            environment: {
                VERSION: '4',
                NODE_OPTIONS: '--enable-source-maps',
                POOL_CACHE_BUCKET: poolCacheBucket.bucketName,
                POOL_CACHE_BUCKET_2: poolCacheBucket2.bucketName,
                POOL_CACHE_KEY: poolCacheKey,
                TOKEN_LIST_CACHE_BUCKET: tokenListCacheBucket.bucketName,
                ETH_GAS_STATION_INFO_URL: ethGasStationInfoUrl,
                CACHED_ROUTES_TABLE_NAME: (_b = cachedRoutesDynamoDb === null || cachedRoutesDynamoDb === void 0 ? void 0 : cachedRoutesDynamoDb.tableName) !== null && _b !== void 0 ? _b : '',
                ...jsonRpcProviders,
            },
            layers: [
                aws_lambda.LayerVersion.fromLayerVersionArn(this, 'InsightsLayerSwapAndAdd', `arn:aws:lambda:${region}:580247275435:layer:LambdaInsightsExtension:14`),
            ],
            tracing: aws_lambda.Tracing.ACTIVE,
        });
        const lambdaAlarmErrorRate = new aws_cloudwatch.Alarm(this, 'RoutingAPI-LambdaErrorRate', {
            metric: new aws_cloudwatch.MathExpression({
                expression: 'errors / invocations',
                usingMetrics: {
                    errors: this.routingLambda.metricErrors({
                        period: Duration.minutes(5),
                        statistic: 'avg',
                    }),
                    invocations: this.routingLambda.metricInvocations({
                        period: Duration.minutes(5),
                        statistic: 'avg',
                    }),
                },
            }),
            threshold: 0.05,
            evaluationPeriods: 3,
        });
        const lambdaThrottlesErrorRate = new aws_cloudwatch.Alarm(this, 'RoutingAPI-LambdaThrottles', {
            metric: this.routingLambda.metricThrottles({
                period: Duration.minutes(5),
                statistic: 'sum',
            }),
            threshold: 10,
            evaluationPeriods: 3,
        });
        if (chatbotSNSArn) {
            const chatBotTopic = aws_sns.Topic.fromTopicArn(this, 'ChatbotTopic', chatbotSNSArn);
            lambdaAlarmErrorRate.addAlarmAction(new aws_cloudwatch_actions.SnsAction(chatBotTopic));
            lambdaThrottlesErrorRate.addAlarmAction(new aws_cloudwatch_actions.SnsAction(chatBotTopic));
        }
        const enableProvisionedConcurrency = provisionedConcurrency > 0;
        this.routingLambdaAlias = new aws_lambda.Alias(this, 'RoutingLiveAlias', {
            aliasName: 'live',
            version: this.routingLambda.currentVersion,
            provisionedConcurrentExecutions: enableProvisionedConcurrency ? provisionedConcurrency : undefined,
        });
        if (enableProvisionedConcurrency) {
            const target = new asg.ScalableTarget(this, 'RoutingProvConcASG', {
                serviceNamespace: asg.ServiceNamespace.LAMBDA,
                maxCapacity: provisionedConcurrency * 5,
                minCapacity: provisionedConcurrency,
                resourceId: `function:${this.routingLambdaAlias.lambda.functionName}:${this.routingLambdaAlias.aliasName}`,
                scalableDimension: 'lambda:function:ProvisionedConcurrency',
            });
            target.node.addDependency(this.routingLambdaAlias);
            target.scaleToTrackMetric('RoutingProvConcTracking', {
                targetValue: 0.8,
                predefinedMetric: asg.PredefinedMetric.LAMBDA_PROVISIONED_CONCURRENCY_UTILIZATION,
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGluZy1sYW1iZGEtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9iaW4vc3RhY2tzL3JvdXRpbmctbGFtYmRhLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxHQUFHLE1BQU0sYUFBYSxDQUFBO0FBQ2xDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFFdEMsT0FBTyxLQUFLLEdBQUcsTUFBTSx3Q0FBd0MsQ0FBQTtBQUM3RCxPQUFPLEtBQUssY0FBYyxNQUFNLDRCQUE0QixDQUFBO0FBQzVELE9BQU8sS0FBSyxzQkFBc0IsTUFBTSxvQ0FBb0MsQ0FBQTtBQUM1RSxPQUFPLEtBQUssT0FBTyxNQUFNLHFCQUFxQixDQUFBO0FBQzlDLE9BQU8sS0FBSyxVQUFVLE1BQU0sd0JBQXdCLENBQUE7QUFDcEQsT0FBTyxLQUFLLGlCQUFpQixNQUFNLCtCQUErQixDQUFBO0FBRWxFLE9BQU8sS0FBSyxPQUFPLE1BQU0scUJBQXFCLENBQUE7QUFFOUMsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUE7QUFnQjVCLE1BQU0sT0FBTyxrQkFBbUIsU0FBUSxHQUFHLENBQUMsV0FBVztJQUtyRCxZQUFZLEtBQWdCLEVBQUUsSUFBWSxFQUFFLEtBQThCOztRQUN4RSxLQUFLLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUN6QixNQUFNLEVBQ0osZUFBZSxFQUNmLGdCQUFnQixFQUNoQixZQUFZLEVBQ1osZ0JBQWdCLEVBQ2hCLG9CQUFvQixFQUNwQixzQkFBc0IsRUFDdEIsb0JBQW9CLEVBQ3BCLGFBQWEsRUFDYixZQUFZLEVBQ1osZUFBZSxFQUNmLGlCQUFpQixFQUNqQixvQkFBb0IsR0FDckIsR0FBRyxLQUFLLENBQUE7UUFFVCxNQUFNLFVBQVUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLG1CQUFtQixFQUFFO1lB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LE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLG9CQUFvQixFQUFFO2dCQUNoRSxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsTUFBTTtnQkFDN0MsV0FBVyxFQUFFLHNCQUFzQixHQUFHLENBQUM7Z0JBQ3ZDLFdBQVcsRUFBRSxzQkFBc0I7Z0JBQ25DLFVBQVUsRUFBRSxZQUFZLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLEVBQUU7Z0JBQzFHLGlCQUFpQixFQUFFLHdDQUF3QzthQUM1RCxDQUFDLENBQUE7WUFFRixNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtZQUVsRCxNQUFNLENBQUMsa0JBQWtCLENBQUMseUJBQXlCLEVBQUU7Z0JBQ25ELFdBQVcsRUFBRSxHQUFHO2dCQUNoQixnQkFBZ0IsRUFBRSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsMENBQTBDO2FBQ2xGLENBQUMsQ0FBQTtTQUNIO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJ1xuaW1wb3J0IHsgRHVyYXRpb24gfSBmcm9tICdhd3MtY2RrLWxpYidcbmltcG9ydCAqIGFzIGF3c19keW5hbW9kYiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGInXG5pbXBvcnQgKiBhcyBhc2cgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwcGxpY2F0aW9uYXV0b3NjYWxpbmcnXG5pbXBvcnQgKiBhcyBhd3NfY2xvdWR3YXRjaCBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY2xvdWR3YXRjaCdcbmltcG9ydCAqIGFzIGF3c19jbG91ZHdhdGNoX2FjdGlvbnMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWNsb3Vkd2F0Y2gtYWN0aW9ucydcbmltcG9ydCAqIGFzIGF3c19pYW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSdcbmltcG9ydCAqIGFzIGF3c19sYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSdcbmltcG9ydCAqIGFzIGF3c19sYW1iZGFfbm9kZWpzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJ1xuaW1wb3J0ICogYXMgYXdzX3MzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMydcbmltcG9ydCAqIGFzIGF3c19zbnMgZnJvbSAnYXdzLWNkay1saWIvYXdzLXNucydcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnXG5cbmV4cG9ydCBpbnRlcmZhY2UgUm91dGluZ0xhbWJkYVN0YWNrUHJvcHMgZXh0ZW5kcyBjZGsuTmVzdGVkU3RhY2tQcm9wcyB7XG4gIHBvb2xDYWNoZUJ1Y2tldDogYXdzX3MzLkJ1Y2tldFxuICBwb29sQ2FjaGVCdWNrZXQyOiBhd3NfczMuQnVja2V0XG4gIHBvb2xDYWNoZUtleTogc3RyaW5nXG4gIGpzb25ScGNQcm92aWRlcnM6IHsgW2NoYWluTmFtZTogc3RyaW5nXTogc3RyaW5nIH1cbiAgdG9rZW5MaXN0Q2FjaGVCdWNrZXQ6IGF3c19zMy5CdWNrZXRcbiAgcHJvdmlzaW9uZWRDb25jdXJyZW5jeTogbnVtYmVyXG4gIGV0aEdhc1N0YXRpb25JbmZvVXJsOiBzdHJpbmdcbiAgdGVuZGVybHlVc2VyOiBzdHJpbmdcbiAgdGVuZGVybHlQcm9qZWN0OiBzdHJpbmdcbiAgdGVuZGVybHlBY2Nlc3NLZXk6IHN0cmluZ1xuICBjaGF0Ym90U05TQXJuPzogc3RyaW5nXG4gIGNhY2hlZFJvdXRlc0R5bmFtb0RiPzogYXdzX2R5bmFtb2RiLlRhYmxlXG59XG5leHBvcnQgY2xhc3MgUm91dGluZ0xhbWJkYVN0YWNrIGV4dGVuZHMgY2RrLk5lc3RlZFN0YWNrIHtcbiAgcHVibGljIHJlYWRvbmx5IHJvdXRpbmdMYW1iZGE6IGF3c19sYW1iZGFfbm9kZWpzLk5vZGVqc0Z1bmN0aW9uXG4gIHB1YmxpYyByZWFkb25seSByb3V0ZVRvUmF0aW9MYW1iZGE6IGF3c19sYW1iZGFfbm9kZWpzLk5vZGVqc0Z1bmN0aW9uXG4gIHB1YmxpYyByZWFkb25seSByb3V0aW5nTGFtYmRhQWxpYXM6IGF3c19sYW1iZGEuQWxpYXNcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBuYW1lOiBzdHJpbmcsIHByb3BzOiBSb3V0aW5nTGFtYmRhU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBuYW1lLCBwcm9wcylcbiAgICBjb25zdCB7XG4gICAgICBwb29sQ2FjaGVCdWNrZXQsXG4gICAgICBwb29sQ2FjaGVCdWNrZXQyLFxuICAgICAgcG9vbENhY2hlS2V5LFxuICAgICAganNvblJwY1Byb3ZpZGVycyxcbiAgICAgIHRva2VuTGlzdENhY2hlQnVja2V0LFxuICAgICAgcHJvdmlzaW9uZWRDb25jdXJyZW5jeSxcbiAgICAgIGV0aEdhc1N0YXRpb25JbmZvVXJsLFxuICAgICAgY2hhdGJvdFNOU0FybixcbiAgICAgIHRlbmRlcmx5VXNlcixcbiAgICAgIHRlbmRlcmx5UHJvamVjdCxcbiAgICAgIHRlbmRlcmx5QWNjZXNzS2V5LFxuICAgICAgY2FjaGVkUm91dGVzRHluYW1vRGIsXG4gICAgfSA9IHByb3BzXG5cbiAgICBjb25zdCBsYW1iZGFSb2xlID0gbmV3IGF3c19pYW0uUm9sZSh0aGlzLCAnUm91dGluZ0xhbWJkYVJvbGUnLCB7XG4gICAgICBhc3N1bWVkQnk6IG5ldyBhd3NfaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2xhbWJkYS5hbWF6b25hd3MuY29tJyksXG4gICAgICBtYW5hZ2VkUG9saWNpZXM6IFtcbiAgICAgICAgYXdzX2lhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZSgnc2VydmljZS1yb2xlL0FXU0xhbWJkYUJhc2ljRXhlY3V0aW9uUm9sZScpLFxuICAgICAgICBhd3NfaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKCdDbG91ZFdhdGNoTGFtYmRhSW5zaWdodHNFeGVjdXRpb25Sb2xlUG9saWN5JyksXG4gICAgICAgIGF3c19pYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ0FXU1hSYXlEYWVtb25Xcml0ZUFjY2VzcycpLFxuICAgICAgXSxcbiAgICB9KVxuICAgIHBvb2xDYWNoZUJ1Y2tldC5ncmFudFJlYWQobGFtYmRhUm9sZSlcbiAgICBwb29sQ2FjaGVCdWNrZXQyLmdyYW50UmVhZChsYW1iZGFSb2xlKVxuICAgIHRva2VuTGlzdENhY2hlQnVja2V0LmdyYW50UmVhZChsYW1iZGFSb2xlKVxuICAgIGNhY2hlZFJvdXRlc0R5bmFtb0RiPy5ncmFudFJlYWRXcml0ZURhdGEobGFtYmRhUm9sZSlcblxuICAgIGNvbnN0IHJlZ2lvbiA9IGNkay5TdGFjay5vZih0aGlzKS5yZWdpb25cblxuICAgIHRoaXMucm91dGluZ0xhbWJkYSA9IG5ldyBhd3NfbGFtYmRhX25vZGVqcy5Ob2RlanNGdW5jdGlvbih0aGlzLCAnUm91dGluZ0xhbWJkYTInLCB7XG4gICAgICByb2xlOiBsYW1iZGFSb2xlLFxuICAgICAgcnVudGltZTogYXdzX2xhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgICAgZW50cnk6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9saWIvaGFuZGxlcnMvaW5kZXgudHMnKSxcbiAgICAgIGhhbmRsZXI6ICdxdW90ZUhhbmRsZXInLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoMjkpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgIG1pbmlmeTogdHJ1ZSxcbiAgICAgICAgc291cmNlTWFwOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIGRlc2NyaXB0aW9uOiAnUm91dGluZyBMYW1iZGEnLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgVkVSU0lPTjogJzUnLFxuICAgICAgICBOT0RFX09QVElPTlM6ICctLWVuYWJsZS1zb3VyY2UtbWFwcycsXG4gICAgICAgIFBPT0xfQ0FDSEVfQlVDS0VUOiBwb29sQ2FjaGVCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgUE9PTF9DQUNIRV9CVUNLRVRfMjogcG9vbENhY2hlQnVja2V0Mi5idWNrZXROYW1lLFxuICAgICAgICBQT09MX0NBQ0hFX0tFWTogcG9vbENhY2hlS2V5LFxuICAgICAgICBUT0tFTl9MSVNUX0NBQ0hFX0JVQ0tFVDogdG9rZW5MaXN0Q2FjaGVCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgRVRIX0dBU19TVEFUSU9OX0lORk9fVVJMOiBldGhHYXNTdGF0aW9uSW5mb1VybCxcbiAgICAgICAgVEVOREVSTFlfVVNFUjogdGVuZGVybHlVc2VyLFxuICAgICAgICBURU5ERVJMWV9QUk9KRUNUOiB0ZW5kZXJseVByb2plY3QsXG4gICAgICAgIFRFTkRFUkxZX0FDQ0VTU19LRVk6IHRlbmRlcmx5QWNjZXNzS2V5LFxuICAgICAgICBDQUNIRURfUk9VVEVTX1RBQkxFX05BTUU6IGNhY2hlZFJvdXRlc0R5bmFtb0RiPy50YWJsZU5hbWUgPz8gJycsXG4gICAgICAgIC4uLmpzb25ScGNQcm92aWRlcnMsXG4gICAgICB9LFxuICAgICAgbGF5ZXJzOiBbXG4gICAgICAgIGF3c19sYW1iZGEuTGF5ZXJWZXJzaW9uLmZyb21MYXllclZlcnNpb25Bcm4oXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICAnSW5zaWdodHNMYXllcicsXG4gICAgICAgICAgYGFybjphd3M6bGFtYmRhOiR7cmVnaW9ufTo1ODAyNDcyNzU0MzU6bGF5ZXI6TGFtYmRhSW5zaWdodHNFeHRlbnNpb246MTRgXG4gICAgICAgICksXG4gICAgICBdLFxuICAgICAgdHJhY2luZzogYXdzX2xhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZVRvUmF0aW9MYW1iZGEgPSBuZXcgYXdzX2xhbWJkYV9ub2RlanMuTm9kZWpzRnVuY3Rpb24odGhpcywgJ1JvdXRlVG9SYXRpb0xhbWJkYTInLCB7XG4gICAgICByb2xlOiBsYW1iZGFSb2xlLFxuICAgICAgcnVudGltZTogYXdzX2xhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgICAgZW50cnk6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9saWIvaGFuZGxlcnMvaW5kZXgudHMnKSxcbiAgICAgIGhhbmRsZXI6ICdxdW90ZVRvUmF0aW9IYW5kbGVyJyxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDI5KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgICBidW5kbGluZzoge1xuICAgICAgICBtaW5pZnk6IHRydWUsXG4gICAgICAgIHNvdXJjZU1hcDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgICBkZXNjcmlwdGlvbjogJ1JvdXRlIHRvIFJhdGlvIExhbWJkYScsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBWRVJTSU9OOiAnNCcsXG4gICAgICAgIE5PREVfT1BUSU9OUzogJy0tZW5hYmxlLXNvdXJjZS1tYXBzJyxcbiAgICAgICAgUE9PTF9DQUNIRV9CVUNLRVQ6IHBvb2xDYWNoZUJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICBQT09MX0NBQ0hFX0JVQ0tFVF8yOiBwb29sQ2FjaGVCdWNrZXQyLmJ1Y2tldE5hbWUsXG4gICAgICAgIFBPT0xfQ0FDSEVfS0VZOiBwb29sQ2FjaGVLZXksXG4gICAgICAgIFRPS0VOX0xJU1RfQ0FDSEVfQlVDS0VUOiB0b2tlbkxpc3RDYWNoZUJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICBFVEhfR0FTX1NUQVRJT05fSU5GT19VUkw6IGV0aEdhc1N0YXRpb25JbmZvVXJsLFxuICAgICAgICBDQUNIRURfUk9VVEVTX1RBQkxFX05BTUU6IGNhY2hlZFJvdXRlc0R5bmFtb0RiPy50YWJsZU5hbWUgPz8gJycsXG4gICAgICAgIC4uLmpzb25ScGNQcm92aWRlcnMsXG4gICAgICB9LFxuICAgICAgbGF5ZXJzOiBbXG4gICAgICAgIGF3c19sYW1iZGEuTGF5ZXJWZXJzaW9uLmZyb21MYXllclZlcnNpb25Bcm4oXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICAnSW5zaWdodHNMYXllclN3YXBBbmRBZGQnLFxuICAgICAgICAgIGBhcm46YXdzOmxhbWJkYToke3JlZ2lvbn06NTgwMjQ3Mjc1NDM1OmxheWVyOkxhbWJkYUluc2lnaHRzRXh0ZW5zaW9uOjE0YFxuICAgICAgICApLFxuICAgICAgXSxcbiAgICAgIHRyYWNpbmc6IGF3c19sYW1iZGEuVHJhY2luZy5BQ1RJVkUsXG4gICAgfSlcblxuICAgIGNvbnN0IGxhbWJkYUFsYXJtRXJyb3JSYXRlID0gbmV3IGF3c19jbG91ZHdhdGNoLkFsYXJtKHRoaXMsICdSb3V0aW5nQVBJLUxhbWJkYUVycm9yUmF0ZScsIHtcbiAgICAgIG1ldHJpYzogbmV3IGF3c19jbG91ZHdhdGNoLk1hdGhFeHByZXNzaW9uKHtcbiAgICAgICAgZXhwcmVzc2lvbjogJ2Vycm9ycyAvIGludm9jYXRpb25zJyxcbiAgICAgICAgdXNpbmdNZXRyaWNzOiB7XG4gICAgICAgICAgZXJyb3JzOiB0aGlzLnJvdXRpbmdMYW1iZGEubWV0cmljRXJyb3JzKHtcbiAgICAgICAgICAgIHBlcmlvZDogRHVyYXRpb24ubWludXRlcyg1KSxcbiAgICAgICAgICAgIHN0YXRpc3RpYzogJ2F2ZycsXG4gICAgICAgICAgfSksXG4gICAgICAgICAgaW52b2NhdGlvbnM6IHRoaXMucm91dGluZ0xhbWJkYS5tZXRyaWNJbnZvY2F0aW9ucyh7XG4gICAgICAgICAgICBwZXJpb2Q6IER1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgICAgICAgICBzdGF0aXN0aWM6ICdhdmcnLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICB0aHJlc2hvbGQ6IDAuMDUsXG4gICAgICBldmFsdWF0aW9uUGVyaW9kczogMyxcbiAgICB9KVxuXG4gICAgY29uc3QgbGFtYmRhVGhyb3R0bGVzRXJyb3JSYXRlID0gbmV3IGF3c19jbG91ZHdhdGNoLkFsYXJtKHRoaXMsICdSb3V0aW5nQVBJLUxhbWJkYVRocm90dGxlcycsIHtcbiAgICAgIG1ldHJpYzogdGhpcy5yb3V0aW5nTGFtYmRhLm1ldHJpY1Rocm90dGxlcyh7XG4gICAgICAgIHBlcmlvZDogRHVyYXRpb24ubWludXRlcyg1KSxcbiAgICAgICAgc3RhdGlzdGljOiAnc3VtJyxcbiAgICAgIH0pLFxuICAgICAgdGhyZXNob2xkOiAxMCxcbiAgICAgIGV2YWx1YXRpb25QZXJpb2RzOiAzLFxuICAgIH0pXG5cbiAgICBpZiAoY2hhdGJvdFNOU0Fybikge1xuICAgICAgY29uc3QgY2hhdEJvdFRvcGljID0gYXdzX3Nucy5Ub3BpYy5mcm9tVG9waWNBcm4odGhpcywgJ0NoYXRib3RUb3BpYycsIGNoYXRib3RTTlNBcm4pXG5cbiAgICAgIGxhbWJkYUFsYXJtRXJyb3JSYXRlLmFkZEFsYXJtQWN0aW9uKG5ldyBhd3NfY2xvdWR3YXRjaF9hY3Rpb25zLlNuc0FjdGlvbihjaGF0Qm90VG9waWMpKVxuXG4gICAgICBsYW1iZGFUaHJvdHRsZXNFcnJvclJhdGUuYWRkQWxhcm1BY3Rpb24obmV3IGF3c19jbG91ZHdhdGNoX2FjdGlvbnMuU25zQWN0aW9uKGNoYXRCb3RUb3BpYykpXG4gICAgfVxuXG4gICAgY29uc3QgZW5hYmxlUHJvdmlzaW9uZWRDb25jdXJyZW5jeSA9IHByb3Zpc2lvbmVkQ29uY3VycmVuY3kgPiAwXG5cbiAgICB0aGlzLnJvdXRpbmdMYW1iZGFBbGlhcyA9IG5ldyBhd3NfbGFtYmRhLkFsaWFzKHRoaXMsICdSb3V0aW5nTGl2ZUFsaWFzJywge1xuICAgICAgYWxpYXNOYW1lOiAnbGl2ZScsXG4gICAgICB2ZXJzaW9uOiB0aGlzLnJvdXRpbmdMYW1iZGEuY3VycmVudFZlcnNpb24sXG4gICAgICBwcm92aXNpb25lZENvbmN1cnJlbnRFeGVjdXRpb25zOiBlbmFibGVQcm92aXNpb25lZENvbmN1cnJlbmN5ID8gcHJvdmlzaW9uZWRDb25jdXJyZW5jeSA6IHVuZGVmaW5lZCxcbiAgICB9KVxuXG4gICAgaWYgKGVuYWJsZVByb3Zpc2lvbmVkQ29uY3VycmVuY3kpIHtcbiAgICAgIGNvbnN0IHRhcmdldCA9IG5ldyBhc2cuU2NhbGFibGVUYXJnZXQodGhpcywgJ1JvdXRpbmdQcm92Q29uY0FTRycsIHtcbiAgICAgICAgc2VydmljZU5hbWVzcGFjZTogYXNnLlNlcnZpY2VOYW1lc3BhY2UuTEFNQkRBLFxuICAgICAgICBtYXhDYXBhY2l0eTogcHJvdmlzaW9uZWRDb25jdXJyZW5jeSAqIDUsXG4gICAgICAgIG1pbkNhcGFjaXR5OiBwcm92aXNpb25lZENvbmN1cnJlbmN5LFxuICAgICAgICByZXNvdXJjZUlkOiBgZnVuY3Rpb246JHt0aGlzLnJvdXRpbmdMYW1iZGFBbGlhcy5sYW1iZGEuZnVuY3Rpb25OYW1lfToke3RoaXMucm91dGluZ0xhbWJkYUFsaWFzLmFsaWFzTmFtZX1gLFxuICAgICAgICBzY2FsYWJsZURpbWVuc2lvbjogJ2xhbWJkYTpmdW5jdGlvbjpQcm92aXNpb25lZENvbmN1cnJlbmN5JyxcbiAgICAgIH0pXG5cbiAgICAgIHRhcmdldC5ub2RlLmFkZERlcGVuZGVuY3kodGhpcy5yb3V0aW5nTGFtYmRhQWxpYXMpXG5cbiAgICAgIHRhcmdldC5zY2FsZVRvVHJhY2tNZXRyaWMoJ1JvdXRpbmdQcm92Q29uY1RyYWNraW5nJywge1xuICAgICAgICB0YXJnZXRWYWx1ZTogMC44LFxuICAgICAgICBwcmVkZWZpbmVkTWV0cmljOiBhc2cuUHJlZGVmaW5lZE1ldHJpYy5MQU1CREFfUFJPVklTSU9ORURfQ09OQ1VSUkVOQ1lfVVRJTElaQVRJT04sXG4gICAgICB9KVxuICAgIH1cbiAgfVxufVxuIl19