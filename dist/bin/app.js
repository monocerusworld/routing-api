import * as cdk from 'aws-cdk-lib';
import { SecretValue, Stack, Stage } from 'aws-cdk-lib';
import * as chatbot from 'aws-cdk-lib/aws-chatbot';
import { BuildEnvironmentVariableType } from 'aws-cdk-lib/aws-codebuild';
import { PipelineNotificationEvents } from 'aws-cdk-lib/aws-codepipeline';
import * as sm from 'aws-cdk-lib/aws-secretsmanager';
import { CodeBuildStep, CodePipeline, CodePipelineSource } from 'aws-cdk-lib/pipelines';
import dotenv from 'dotenv';
import 'source-map-support/register';
import { SUPPORTED_CHAINS } from '../lib/handlers/injector-sor';
import { STAGE } from '../lib/util/stage';
import { RoutingAPIStack } from './stacks/routing-api-stack';
dotenv.config();
export class RoutingAPIStage extends Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const { jsonRpcProviders, provisionedConcurrency, ethGasStationInfoUrl, chatbotSNSArn, stage, route53Arn, pinata_key, pinata_secret, hosted_zone, tenderlyUser, tenderlyProject, tenderlyAccessKey, } = props;
        const { url } = new RoutingAPIStack(this, 'RoutingAPIStack', {
            jsonRpcProviders,
            provisionedConcurrency,
            ethGasStationInfoUrl,
            chatbotSNSArn,
            stage,
            route53Arn,
            pinata_key,
            pinata_secret,
            hosted_zone,
            tenderlyUser,
            tenderlyProject,
            tenderlyAccessKey,
        });
        this.url = url;
    }
}
export class RoutingAPIPipeline extends Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const code = CodePipelineSource.gitHub('Uniswap/routing-api', 'main', {
            authentication: SecretValue.secretsManager('github-token-2'),
        });
        const synthStep = new CodeBuildStep('Synth', {
            input: code,
            buildEnvironment: {
                environmentVariables: {
                    NPM_TOKEN: {
                        value: 'npm-private-repo-access-token',
                        type: BuildEnvironmentVariableType.SECRETS_MANAGER,
                    },
                },
            },
            commands: [
                'echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc && npm ci',
                'npm run build',
                'npx cdk synth',
            ],
        });
        const pipeline = new CodePipeline(this, 'RoutingAPIPipeline', {
            // The pipeline name
            pipelineName: 'RoutingAPI',
            crossAccountKeys: true,
            synth: synthStep,
        });
        // Secrets are stored in secrets manager in the pipeline account. Accounts we deploy to
        // have been granted permissions to access secrets via resource policies.
        const jsonRpcProvidersSecret = sm.Secret.fromSecretAttributes(this, 'RPCProviderUrls', {
            // The main secrets use our Infura RPC urls
            secretCompleteArn: 'arn:aws:secretsmanager:ap-southeast-1:557822834307:secret:routing-api-rpc-urls-json-primary-ixS8mw',
            /*
            The backup secrets mostly use our Alchemy RPC urls
            However Alchemy does not support Rinkeby, Ropsten, and Kovan
            So those chains are set to our Infura RPC urls
            When switching to the backups,
            we must set the multicall chunk size to 50 so that optimism
            does not bug out on Alchemy's end
            */
            //secretCompleteArn: arn:aws:secretsmanager:ap-southeast-1:557822834307:secret:routing-api-rpc-urls-json-backup-D2sWoe
        });
        const tenderlyCreds = sm.Secret.fromSecretAttributes(this, 'TenderlyCreds', {
            secretCompleteArn: 'arn:aws:secretsmanager:ap-southeast-1:557822834307:secret:tenderly-api-wQaI2R',
        });
        const ethGasStationInfoUrl = sm.Secret.fromSecretAttributes(this, 'ETHGasStationUrl', {
            secretCompleteArn: 'arn:aws:secretsmanager:ap-southeast-1:557822834307:secret:eth-gas-station-info-url-ulGncX',
        });
        const pinataApi = sm.Secret.fromSecretAttributes(this, 'PinataAPI', {
            secretCompleteArn: 'arn:aws:secretsmanager:ap-southeast-1:557822834307:secret:pinata-api-key-UVLAfM',
        });
        const route53Arn = sm.Secret.fromSecretAttributes(this, 'Route53Arn', {
            secretCompleteArn: 'arn:aws:secretsmanager:ap-southeast-1:557822834307:secret:Route53Arn-elRmmw',
        });
        const pinataSecret = sm.Secret.fromSecretAttributes(this, 'PinataSecret', {
            secretCompleteArn: 'arn:aws:secretsmanager:ap-southeast-1:557822834307:secret:pinata-secret-svGaPt',
        });
        const hostedZone = sm.Secret.fromSecretAttributes(this, 'HostedZone', {
            secretCompleteArn: 'arn:aws:secretsmanager:ap-southeast-1:557822834307:secret:hosted-zone-JmPDNV',
        });
        // Parse AWS Secret
        let jsonRpcProviders = {};
        SUPPORTED_CHAINS.forEach((chainId) => {
            // TODO: Change this to `JSON_RPC_PROVIDER_${}` to be consistent with SOR
            const key = `WEB3_RPC_${chainId}`;
            jsonRpcProviders[key] = jsonRpcProvidersSecret.secretValueFromJson(key).toString();
        });
        // Beta ap-southeast-1
        const betaUsEast2Stage = new RoutingAPIStage(this, 'beta-ap-southeast-1', {
            env: { account: '557822834307', region: 'ap-southeast-1' },
            jsonRpcProviders: jsonRpcProviders,
            provisionedConcurrency: 100,
            ethGasStationInfoUrl: ethGasStationInfoUrl.secretValue.toString(),
            stage: STAGE.BETA,
            route53Arn: route53Arn.secretValueFromJson('arn').toString(),
            pinata_key: pinataApi.secretValueFromJson('pinata-api-key').toString(),
            pinata_secret: pinataSecret.secretValueFromJson('secret').toString(),
            hosted_zone: hostedZone.secretValueFromJson('zone').toString(),
            tenderlyUser: tenderlyCreds.secretValueFromJson('tenderly-user').toString(),
            tenderlyProject: tenderlyCreds.secretValueFromJson('tenderly-project').toString(),
            tenderlyAccessKey: tenderlyCreds.secretValueFromJson('tenderly-access-key').toString(),
        });
        const betaUsEast2AppStage = pipeline.addStage(betaUsEast2Stage);
        this.addIntegTests(code, betaUsEast2Stage, betaUsEast2AppStage);
        // Prod ap-southeast-1
        const prodUsEast2Stage = new RoutingAPIStage(this, 'prod-ap-southeast-1', {
            env: { account: '557822834307', region: 'ap-southeast-1' },
            jsonRpcProviders: jsonRpcProviders,
            provisionedConcurrency: 100,
            ethGasStationInfoUrl: ethGasStationInfoUrl.secretValue.toString(),
            chatbotSNSArn: 'arn:aws:sns:ap-southeast-1:557822834307:SlackChatbotTopic',
            stage: STAGE.PROD,
            route53Arn: route53Arn.secretValueFromJson('arn').toString(),
            pinata_key: pinataApi.secretValueFromJson('pinata-api-key').toString(),
            pinata_secret: pinataSecret.secretValueFromJson('secret').toString(),
            hosted_zone: hostedZone.secretValueFromJson('zone').toString(),
            tenderlyUser: tenderlyCreds.secretValueFromJson('tenderly-user').toString(),
            tenderlyProject: tenderlyCreds.secretValueFromJson('tenderly-project').toString(),
            tenderlyAccessKey: tenderlyCreds.secretValueFromJson('tenderly-access-key').toString(),
        });
        const prodUsEast2AppStage = pipeline.addStage(prodUsEast2Stage);
        this.addIntegTests(code, prodUsEast2Stage, prodUsEast2AppStage);
        const slackChannel = chatbot.SlackChannelConfiguration.fromSlackChannelConfigurationArn(this, 'SlackChannel', 'arn:aws:chatbot::557822834307:chat-configuration/slack-channel/eng-ops-slack-chatbot');
        pipeline.buildPipeline();
        pipeline.pipeline.notifyOn('NotifySlack', slackChannel, {
            events: [PipelineNotificationEvents.PIPELINE_EXECUTION_FAILED],
        });
    }
    addIntegTests(sourceArtifact, routingAPIStage, applicationStage) {
        const testAction = new CodeBuildStep(`IntegTests-${routingAPIStage.stageName}`, {
            projectName: `IntegTests-${routingAPIStage.stageName}`,
            input: sourceArtifact,
            envFromCfnOutputs: {
                UNISWAP_ROUTING_API: routingAPIStage.url,
            },
            buildEnvironment: {
                environmentVariables: {
                    NPM_TOKEN: {
                        value: 'npm-private-repo-access-token',
                        type: BuildEnvironmentVariableType.SECRETS_MANAGER,
                    },
                    ARCHIVE_NODE_RPC: {
                        value: 'archive-node-rpc-url-default-kms',
                        type: BuildEnvironmentVariableType.SECRETS_MANAGER,
                    },
                },
            },
            commands: [
                'echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc && npm ci',
                'echo "UNISWAP_ROUTING_API=${UNISWAP_ROUTING_API}" > .env',
                'echo "ARCHIVE_NODE_RPC=${ARCHIVE_NODE_RPC}" >> .env',
                'npm install',
                'npm run build',
                'npm run integ-test',
            ],
        });
        applicationStage.addPost(testAction);
    }
}
const app = new cdk.App();
const jsonRpcProviders = {
    WEB3_RPC_1: process.env.JSON_RPC_PROVIDER_1,
    WEB3_RPC_3: process.env.JSON_RPC_PROVIDER_3,
    WEB3_RPC_4: process.env.JSON_RPC_PROVIDER_4,
    WEB3_RPC_5: process.env.JSON_RPC_PROVIDER_5,
    WEB3_RPC_42: process.env.JSON_RPC_PROVIDER_42,
    WEB3_RPC_10: process.env.JSON_RPC_PROVIDER_10,
    WEB3_RPC_69: process.env.JSON_RPC_PROVIDER_69,
    WEB3_RPC_42161: process.env.JSON_RPC_PROVIDER_42161,
    WEB3_RPC_421611: process.env.JSON_RPC_PROVIDER_421611,
    WEB3_RPC_421613: process.env.JSON_RPC_PROVIDER_421613,
    WEB3_RPC_137: process.env.JSON_RPC_PROVIDER_137,
    WEB3_RPC_80001: process.env.JSON_RPC_PROVIDER_80001,
    WEB3_RPC_42220: process.env.JSON_RPC_PROVIDER_42220,
    WEB3_RPC_44787: process.env.JSON_RPC_PROVIDER_44787,
    WEB3_RPC_56: process.env.JSON_RPC_PROVIDER_56,
};
// Local dev stack
new RoutingAPIStack(app, 'RoutingAPIStack', {
    jsonRpcProviders: jsonRpcProviders,
    provisionedConcurrency: process.env.PROVISION_CONCURRENCY ? parseInt(process.env.PROVISION_CONCURRENCY) : 0,
    throttlingOverride: process.env.THROTTLE_PER_FIVE_MINS,
    ethGasStationInfoUrl: process.env.ETH_GAS_STATION_INFO_URL,
    chatbotSNSArn: process.env.CHATBOT_SNS_ARN,
    stage: STAGE.LOCAL,
    route53Arn: process.env.ROLE_ARN,
    pinata_key: process.env.PINATA_API_KEY,
    pinata_secret: process.env.PINATA_API_SECRET,
    hosted_zone: process.env.HOSTED_ZONE,
    tenderlyUser: process.env.TENDERLY_USER,
    tenderlyProject: process.env.TENDERLY_PROJECT,
    tenderlyAccessKey: process.env.TENDERLY_ACCESS_KEY,
});
new RoutingAPIPipeline(app, 'RoutingAPIPipelineStack', {
    env: { account: '557822834307', region: 'ap-southeast-1' },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vYmluL2FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEtBQUssR0FBRyxNQUFNLGFBQWEsQ0FBQTtBQUNsQyxPQUFPLEVBQWEsV0FBVyxFQUFFLEtBQUssRUFBYyxLQUFLLEVBQWMsTUFBTSxhQUFhLENBQUE7QUFDMUYsT0FBTyxLQUFLLE9BQU8sTUFBTSx5QkFBeUIsQ0FBQTtBQUNsRCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQTtBQUN4RSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQUN6RSxPQUFPLEtBQUssRUFBRSxNQUFNLGdDQUFnQyxDQUFBO0FBQ3BELE9BQU8sRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFFdkYsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFBO0FBQzNCLE9BQU8sNkJBQTZCLENBQUE7QUFDcEMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFDL0QsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBQ3pDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQTtBQUM1RCxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUE7QUFFZixNQUFNLE9BQU8sZUFBZ0IsU0FBUSxLQUFLO0lBR3hDLFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLEtBYUM7UUFFRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUN2QixNQUFNLEVBQ0osZ0JBQWdCLEVBQ2hCLHNCQUFzQixFQUN0QixvQkFBb0IsRUFDcEIsYUFBYSxFQUNiLEtBQUssRUFDTCxVQUFVLEVBQ1YsVUFBVSxFQUNWLGFBQWEsRUFDYixXQUFXLEVBQ1gsWUFBWSxFQUNaLGVBQWUsRUFDZixpQkFBaUIsR0FDbEIsR0FBRyxLQUFLLENBQUE7UUFFVCxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxlQUFlLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFO1lBQzNELGdCQUFnQjtZQUNoQixzQkFBc0I7WUFDdEIsb0JBQW9CO1lBQ3BCLGFBQWE7WUFDYixLQUFLO1lBQ0wsVUFBVTtZQUNWLFVBQVU7WUFDVixhQUFhO1lBQ2IsV0FBVztZQUNYLFlBQVk7WUFDWixlQUFlO1lBQ2YsaUJBQWlCO1NBQ2xCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFBO0lBQ2hCLENBQUM7Q0FDRjtBQUVELE1BQU0sT0FBTyxrQkFBbUIsU0FBUSxLQUFLO0lBQzNDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBa0I7UUFDMUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFFdkIsTUFBTSxJQUFJLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxDQUFDLHFCQUFxQixFQUFFLE1BQU0sRUFBRTtZQUNwRSxjQUFjLEVBQUUsV0FBVyxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQztTQUM3RCxDQUFDLENBQUE7UUFFRixNQUFNLFNBQVMsR0FBRyxJQUFJLGFBQWEsQ0FBQyxPQUFPLEVBQUU7WUFDM0MsS0FBSyxFQUFFLElBQUk7WUFDWCxnQkFBZ0IsRUFBRTtnQkFDaEIsb0JBQW9CLEVBQUU7b0JBQ3BCLFNBQVMsRUFBRTt3QkFDVCxLQUFLLEVBQUUsK0JBQStCO3dCQUN0QyxJQUFJLEVBQUUsNEJBQTRCLENBQUMsZUFBZTtxQkFDbkQ7aUJBQ0Y7YUFDRjtZQUNELFFBQVEsRUFBRTtnQkFDUix5RUFBeUU7Z0JBQ3pFLGVBQWU7Z0JBQ2YsZUFBZTthQUNoQjtTQUNGLENBQUMsQ0FBQTtRQUVGLE1BQU0sUUFBUSxHQUFHLElBQUksWUFBWSxDQUFDLElBQUksRUFBRSxvQkFBb0IsRUFBRTtZQUM1RCxvQkFBb0I7WUFDcEIsWUFBWSxFQUFFLFlBQVk7WUFDMUIsZ0JBQWdCLEVBQUUsSUFBSTtZQUN0QixLQUFLLEVBQUUsU0FBUztTQUNqQixDQUFDLENBQUE7UUFFRix1RkFBdUY7UUFDdkYseUVBQXlFO1FBRXpFLE1BQU0sc0JBQXNCLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUU7WUFDckYsMkNBQTJDO1lBQzNDLGlCQUFpQixFQUNmLG9HQUFvRztZQUV0Rzs7Ozs7OztjQU9FO1lBQ0Ysc0hBQXNIO1NBQ3ZILENBQUMsQ0FBQTtRQUVGLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLGVBQWUsRUFBRTtZQUMxRSxpQkFBaUIsRUFBRSwrRUFBK0U7U0FDbkcsQ0FBQyxDQUFBO1FBRUYsTUFBTSxvQkFBb0IsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUNwRixpQkFBaUIsRUFBRSwyRkFBMkY7U0FDL0csQ0FBQyxDQUFBO1FBRUYsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFO1lBQ2xFLGlCQUFpQixFQUFFLGlGQUFpRjtTQUNyRyxDQUFDLENBQUE7UUFDRixNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7WUFDcEUsaUJBQWlCLEVBQUUsNkVBQTZFO1NBQ2pHLENBQUMsQ0FBQTtRQUVGLE1BQU0sWUFBWSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRTtZQUN4RSxpQkFBaUIsRUFBRSxnRkFBZ0Y7U0FDcEcsQ0FBQyxDQUFBO1FBRUYsTUFBTSxVQUFVLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFO1lBQ3BFLGlCQUFpQixFQUFFLDhFQUE4RTtTQUNsRyxDQUFDLENBQUE7UUFFRixtQkFBbUI7UUFDbkIsSUFBSSxnQkFBZ0IsR0FBRyxFQUFtQyxDQUFBO1FBQzFELGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQWdCLEVBQUUsRUFBRTtZQUM1Qyx5RUFBeUU7WUFDekUsTUFBTSxHQUFHLEdBQUcsWUFBWSxPQUFPLEVBQUUsQ0FBQTtZQUNqQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxzQkFBc0IsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUNwRixDQUFDLENBQUMsQ0FBQTtRQUVGLHNCQUFzQjtRQUN0QixNQUFNLGdCQUFnQixHQUFHLElBQUksZUFBZSxDQUFDLElBQUksRUFBRSxxQkFBcUIsRUFBRTtZQUN4RSxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRTtZQUMxRCxnQkFBZ0IsRUFBRSxnQkFBZ0I7WUFDbEMsc0JBQXNCLEVBQUUsR0FBRztZQUMzQixvQkFBb0IsRUFBRSxvQkFBb0IsQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFO1lBQ2pFLEtBQUssRUFBRSxLQUFLLENBQUMsSUFBSTtZQUNqQixVQUFVLEVBQUUsVUFBVSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRTtZQUM1RCxVQUFVLEVBQUUsU0FBUyxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDLENBQUMsUUFBUSxFQUFFO1lBQ3RFLGFBQWEsRUFBRSxZQUFZLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxFQUFFO1lBQ3BFLFdBQVcsRUFBRSxVQUFVLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxFQUFFO1lBQzlELFlBQVksRUFBRSxhQUFhLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLENBQUMsUUFBUSxFQUFFO1lBQzNFLGVBQWUsRUFBRSxhQUFhLENBQUMsbUJBQW1CLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxRQUFRLEVBQUU7WUFDakYsaUJBQWlCLEVBQUUsYUFBYSxDQUFDLG1CQUFtQixDQUFDLHFCQUFxQixDQUFDLENBQUMsUUFBUSxFQUFFO1NBQ3ZGLENBQUMsQ0FBQTtRQUVGLE1BQU0sbUJBQW1CLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO1FBRS9ELElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFLG1CQUFtQixDQUFDLENBQUE7UUFFL0Qsc0JBQXNCO1FBQ3RCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxlQUFlLENBQUMsSUFBSSxFQUFFLHFCQUFxQixFQUFFO1lBQ3hFLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFFO1lBQzFELGdCQUFnQixFQUFFLGdCQUFnQjtZQUNsQyxzQkFBc0IsRUFBRSxHQUFHO1lBQzNCLG9CQUFvQixFQUFFLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUU7WUFDakUsYUFBYSxFQUFFLDJEQUEyRDtZQUMxRSxLQUFLLEVBQUUsS0FBSyxDQUFDLElBQUk7WUFDakIsVUFBVSxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLEVBQUU7WUFDNUQsVUFBVSxFQUFFLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLFFBQVEsRUFBRTtZQUN0RSxhQUFhLEVBQUUsWUFBWSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsRUFBRTtZQUNwRSxXQUFXLEVBQUUsVUFBVSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRTtZQUM5RCxZQUFZLEVBQUUsYUFBYSxDQUFDLG1CQUFtQixDQUFDLGVBQWUsQ0FBQyxDQUFDLFFBQVEsRUFBRTtZQUMzRSxlQUFlLEVBQUUsYUFBYSxDQUFDLG1CQUFtQixDQUFDLGtCQUFrQixDQUFDLENBQUMsUUFBUSxFQUFFO1lBQ2pGLGlCQUFpQixFQUFFLGFBQWEsQ0FBQyxtQkFBbUIsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLFFBQVEsRUFBRTtTQUN2RixDQUFDLENBQUE7UUFFRixNQUFNLG1CQUFtQixHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtRQUUvRCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsQ0FBQyxDQUFBO1FBRS9ELE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxnQ0FBZ0MsQ0FDckYsSUFBSSxFQUNKLGNBQWMsRUFDZCxzRkFBc0YsQ0FDdkYsQ0FBQTtRQUVELFFBQVEsQ0FBQyxhQUFhLEVBQUUsQ0FBQTtRQUN4QixRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsWUFBWSxFQUFFO1lBQ3RELE1BQU0sRUFBRSxDQUFDLDBCQUEwQixDQUFDLHlCQUF5QixDQUFDO1NBQy9ELENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFTyxhQUFhLENBQ25CLGNBQWdELEVBQ2hELGVBQWdDLEVBQ2hDLGdCQUErQztRQUUvQyxNQUFNLFVBQVUsR0FBRyxJQUFJLGFBQWEsQ0FBQyxjQUFjLGVBQWUsQ0FBQyxTQUFTLEVBQUUsRUFBRTtZQUM5RSxXQUFXLEVBQUUsY0FBYyxlQUFlLENBQUMsU0FBUyxFQUFFO1lBQ3RELEtBQUssRUFBRSxjQUFjO1lBQ3JCLGlCQUFpQixFQUFFO2dCQUNqQixtQkFBbUIsRUFBRSxlQUFlLENBQUMsR0FBRzthQUN6QztZQUNELGdCQUFnQixFQUFFO2dCQUNoQixvQkFBb0IsRUFBRTtvQkFDcEIsU0FBUyxFQUFFO3dCQUNULEtBQUssRUFBRSwrQkFBK0I7d0JBQ3RDLElBQUksRUFBRSw0QkFBNEIsQ0FBQyxlQUFlO3FCQUNuRDtvQkFDRCxnQkFBZ0IsRUFBRTt3QkFDaEIsS0FBSyxFQUFFLGtDQUFrQzt3QkFDekMsSUFBSSxFQUFFLDRCQUE0QixDQUFDLGVBQWU7cUJBQ25EO2lCQUNGO2FBQ0Y7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IseUVBQXlFO2dCQUN6RSwwREFBMEQ7Z0JBQzFELHFEQUFxRDtnQkFDckQsYUFBYTtnQkFDYixlQUFlO2dCQUNmLG9CQUFvQjthQUNyQjtTQUNGLENBQUMsQ0FBQTtRQUVGLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUN0QyxDQUFDO0NBQ0Y7QUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtBQUV6QixNQUFNLGdCQUFnQixHQUFHO0lBQ3ZCLFVBQVUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFvQjtJQUM1QyxVQUFVLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBb0I7SUFDNUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW9CO0lBQzVDLFVBQVUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFvQjtJQUM1QyxXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBcUI7SUFDOUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQXFCO0lBQzlDLFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFxQjtJQUM5QyxjQUFjLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBd0I7SUFDcEQsZUFBZSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXlCO0lBQ3RELGVBQWUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF5QjtJQUN0RCxZQUFZLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBc0I7SUFDaEQsY0FBYyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXdCO0lBQ3BELGNBQWMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF3QjtJQUNwRCxjQUFjLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBd0I7SUFDcEQsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQXFCO0NBQy9DLENBQUE7QUFFRCxrQkFBa0I7QUFDbEIsSUFBSSxlQUFlLENBQUMsR0FBRyxFQUFFLGlCQUFpQixFQUFFO0lBQzFDLGdCQUFnQixFQUFFLGdCQUFnQjtJQUNsQyxzQkFBc0IsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNHLGtCQUFrQixFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCO0lBQ3RELG9CQUFvQixFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXlCO0lBQzNELGFBQWEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWU7SUFDMUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO0lBQ2xCLFVBQVUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVE7SUFDaEMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBZTtJQUN2QyxhQUFhLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBa0I7SUFDN0MsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBWTtJQUNyQyxZQUFZLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFjO0lBQ3hDLGVBQWUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFpQjtJQUM5QyxpQkFBaUIsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFvQjtDQUNwRCxDQUFDLENBQUE7QUFFRixJQUFJLGtCQUFrQixDQUFDLEdBQUcsRUFBRSx5QkFBeUIsRUFBRTtJQUNyRCxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRTtDQUMzRCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFpbklkIH0gZnJvbSAnQHRhcnR6LW9uZS9zbWFydC1vcmRlci1yb3V0ZXInXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInXG5pbXBvcnQgeyBDZm5PdXRwdXQsIFNlY3JldFZhbHVlLCBTdGFjaywgU3RhY2tQcm9wcywgU3RhZ2UsIFN0YWdlUHJvcHMgfSBmcm9tICdhd3MtY2RrLWxpYidcbmltcG9ydCAqIGFzIGNoYXRib3QgZnJvbSAnYXdzLWNkay1saWIvYXdzLWNoYXRib3QnXG5pbXBvcnQgeyBCdWlsZEVudmlyb25tZW50VmFyaWFibGVUeXBlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWNvZGVidWlsZCdcbmltcG9ydCB7IFBpcGVsaW5lTm90aWZpY2F0aW9uRXZlbnRzIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWNvZGVwaXBlbGluZSdcbmltcG9ydCAqIGFzIHNtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zZWNyZXRzbWFuYWdlcidcbmltcG9ydCB7IENvZGVCdWlsZFN0ZXAsIENvZGVQaXBlbGluZSwgQ29kZVBpcGVsaW5lU291cmNlIH0gZnJvbSAnYXdzLWNkay1saWIvcGlwZWxpbmVzJ1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cydcbmltcG9ydCBkb3RlbnYgZnJvbSAnZG90ZW52J1xuaW1wb3J0ICdzb3VyY2UtbWFwLXN1cHBvcnQvcmVnaXN0ZXInXG5pbXBvcnQgeyBTVVBQT1JURURfQ0hBSU5TIH0gZnJvbSAnLi4vbGliL2hhbmRsZXJzL2luamVjdG9yLXNvcidcbmltcG9ydCB7IFNUQUdFIH0gZnJvbSAnLi4vbGliL3V0aWwvc3RhZ2UnXG5pbXBvcnQgeyBSb3V0aW5nQVBJU3RhY2sgfSBmcm9tICcuL3N0YWNrcy9yb3V0aW5nLWFwaS1zdGFjaydcbmRvdGVudi5jb25maWcoKVxuXG5leHBvcnQgY2xhc3MgUm91dGluZ0FQSVN0YWdlIGV4dGVuZHMgU3RhZ2Uge1xuICBwdWJsaWMgcmVhZG9ubHkgdXJsOiBDZm5PdXRwdXRcblxuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IFN0YWdlUHJvcHMgJiB7XG4gICAgICBqc29uUnBjUHJvdmlkZXJzOiB7IFtjaGFpbk5hbWU6IHN0cmluZ106IHN0cmluZyB9XG4gICAgICBwcm92aXNpb25lZENvbmN1cnJlbmN5OiBudW1iZXJcbiAgICAgIGV0aEdhc1N0YXRpb25JbmZvVXJsOiBzdHJpbmdcbiAgICAgIGNoYXRib3RTTlNBcm4/OiBzdHJpbmdcbiAgICAgIHN0YWdlOiBzdHJpbmdcbiAgICAgIHJvdXRlNTNBcm4/OiBzdHJpbmdcbiAgICAgIHBpbmF0YV9rZXk/OiBzdHJpbmdcbiAgICAgIHBpbmF0YV9zZWNyZXQ/OiBzdHJpbmdcbiAgICAgIGhvc3RlZF96b25lPzogc3RyaW5nXG4gICAgICB0ZW5kZXJseVVzZXI6IHN0cmluZ1xuICAgICAgdGVuZGVybHlQcm9qZWN0OiBzdHJpbmdcbiAgICAgIHRlbmRlcmx5QWNjZXNzS2V5OiBzdHJpbmdcbiAgICB9XG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpXG4gICAgY29uc3Qge1xuICAgICAganNvblJwY1Byb3ZpZGVycyxcbiAgICAgIHByb3Zpc2lvbmVkQ29uY3VycmVuY3ksXG4gICAgICBldGhHYXNTdGF0aW9uSW5mb1VybCxcbiAgICAgIGNoYXRib3RTTlNBcm4sXG4gICAgICBzdGFnZSxcbiAgICAgIHJvdXRlNTNBcm4sXG4gICAgICBwaW5hdGFfa2V5LFxuICAgICAgcGluYXRhX3NlY3JldCxcbiAgICAgIGhvc3RlZF96b25lLFxuICAgICAgdGVuZGVybHlVc2VyLFxuICAgICAgdGVuZGVybHlQcm9qZWN0LFxuICAgICAgdGVuZGVybHlBY2Nlc3NLZXksXG4gICAgfSA9IHByb3BzXG5cbiAgICBjb25zdCB7IHVybCB9ID0gbmV3IFJvdXRpbmdBUElTdGFjayh0aGlzLCAnUm91dGluZ0FQSVN0YWNrJywge1xuICAgICAganNvblJwY1Byb3ZpZGVycyxcbiAgICAgIHByb3Zpc2lvbmVkQ29uY3VycmVuY3ksXG4gICAgICBldGhHYXNTdGF0aW9uSW5mb1VybCxcbiAgICAgIGNoYXRib3RTTlNBcm4sXG4gICAgICBzdGFnZSxcbiAgICAgIHJvdXRlNTNBcm4sXG4gICAgICBwaW5hdGFfa2V5LFxuICAgICAgcGluYXRhX3NlY3JldCxcbiAgICAgIGhvc3RlZF96b25lLFxuICAgICAgdGVuZGVybHlVc2VyLFxuICAgICAgdGVuZGVybHlQcm9qZWN0LFxuICAgICAgdGVuZGVybHlBY2Nlc3NLZXksXG4gICAgfSlcbiAgICB0aGlzLnVybCA9IHVybFxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSb3V0aW5nQVBJUGlwZWxpbmUgZXh0ZW5kcyBTdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpXG5cbiAgICBjb25zdCBjb2RlID0gQ29kZVBpcGVsaW5lU291cmNlLmdpdEh1YignVW5pc3dhcC9yb3V0aW5nLWFwaScsICdtYWluJywge1xuICAgICAgYXV0aGVudGljYXRpb246IFNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKCdnaXRodWItdG9rZW4tMicpLFxuICAgIH0pXG5cbiAgICBjb25zdCBzeW50aFN0ZXAgPSBuZXcgQ29kZUJ1aWxkU3RlcCgnU3ludGgnLCB7XG4gICAgICBpbnB1dDogY29kZSxcbiAgICAgIGJ1aWxkRW52aXJvbm1lbnQ6IHtcbiAgICAgICAgZW52aXJvbm1lbnRWYXJpYWJsZXM6IHtcbiAgICAgICAgICBOUE1fVE9LRU46IHtcbiAgICAgICAgICAgIHZhbHVlOiAnbnBtLXByaXZhdGUtcmVwby1hY2Nlc3MtdG9rZW4nLFxuICAgICAgICAgICAgdHlwZTogQnVpbGRFbnZpcm9ubWVudFZhcmlhYmxlVHlwZS5TRUNSRVRTX01BTkFHRVIsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBjb21tYW5kczogW1xuICAgICAgICAnZWNobyBcIi8vcmVnaXN0cnkubnBtanMub3JnLzpfYXV0aFRva2VuPSR7TlBNX1RPS0VOfVwiID4gLm5wbXJjICYmIG5wbSBjaScsXG4gICAgICAgICducG0gcnVuIGJ1aWxkJyxcbiAgICAgICAgJ25weCBjZGsgc3ludGgnLFxuICAgICAgXSxcbiAgICB9KVxuXG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgQ29kZVBpcGVsaW5lKHRoaXMsICdSb3V0aW5nQVBJUGlwZWxpbmUnLCB7XG4gICAgICAvLyBUaGUgcGlwZWxpbmUgbmFtZVxuICAgICAgcGlwZWxpbmVOYW1lOiAnUm91dGluZ0FQSScsXG4gICAgICBjcm9zc0FjY291bnRLZXlzOiB0cnVlLFxuICAgICAgc3ludGg6IHN5bnRoU3RlcCxcbiAgICB9KVxuXG4gICAgLy8gU2VjcmV0cyBhcmUgc3RvcmVkIGluIHNlY3JldHMgbWFuYWdlciBpbiB0aGUgcGlwZWxpbmUgYWNjb3VudC4gQWNjb3VudHMgd2UgZGVwbG95IHRvXG4gICAgLy8gaGF2ZSBiZWVuIGdyYW50ZWQgcGVybWlzc2lvbnMgdG8gYWNjZXNzIHNlY3JldHMgdmlhIHJlc291cmNlIHBvbGljaWVzLlxuXG4gICAgY29uc3QganNvblJwY1Byb3ZpZGVyc1NlY3JldCA9IHNtLlNlY3JldC5mcm9tU2VjcmV0QXR0cmlidXRlcyh0aGlzLCAnUlBDUHJvdmlkZXJVcmxzJywge1xuICAgICAgLy8gVGhlIG1haW4gc2VjcmV0cyB1c2Ugb3VyIEluZnVyYSBSUEMgdXJsc1xuICAgICAgc2VjcmV0Q29tcGxldGVBcm46XG4gICAgICAgICdhcm46YXdzOnNlY3JldHNtYW5hZ2VyOmFwLXNvdXRoZWFzdC0xOjU1NzgyMjgzNDMwNzpzZWNyZXQ6cm91dGluZy1hcGktcnBjLXVybHMtanNvbi1wcmltYXJ5LWl4UzhtdycsXG5cbiAgICAgIC8qXG4gICAgICBUaGUgYmFja3VwIHNlY3JldHMgbW9zdGx5IHVzZSBvdXIgQWxjaGVteSBSUEMgdXJsc1xuICAgICAgSG93ZXZlciBBbGNoZW15IGRvZXMgbm90IHN1cHBvcnQgUmlua2VieSwgUm9wc3RlbiwgYW5kIEtvdmFuXG4gICAgICBTbyB0aG9zZSBjaGFpbnMgYXJlIHNldCB0byBvdXIgSW5mdXJhIFJQQyB1cmxzXG4gICAgICBXaGVuIHN3aXRjaGluZyB0byB0aGUgYmFja3VwcyxcbiAgICAgIHdlIG11c3Qgc2V0IHRoZSBtdWx0aWNhbGwgY2h1bmsgc2l6ZSB0byA1MCBzbyB0aGF0IG9wdGltaXNtXG4gICAgICBkb2VzIG5vdCBidWcgb3V0IG9uIEFsY2hlbXkncyBlbmRcbiAgICAgICovXG4gICAgICAvL3NlY3JldENvbXBsZXRlQXJuOiBhcm46YXdzOnNlY3JldHNtYW5hZ2VyOmFwLXNvdXRoZWFzdC0xOjU1NzgyMjgzNDMwNzpzZWNyZXQ6cm91dGluZy1hcGktcnBjLXVybHMtanNvbi1iYWNrdXAtRDJzV29lXG4gICAgfSlcblxuICAgIGNvbnN0IHRlbmRlcmx5Q3JlZHMgPSBzbS5TZWNyZXQuZnJvbVNlY3JldEF0dHJpYnV0ZXModGhpcywgJ1RlbmRlcmx5Q3JlZHMnLCB7XG4gICAgICBzZWNyZXRDb21wbGV0ZUFybjogJ2Fybjphd3M6c2VjcmV0c21hbmFnZXI6YXAtc291dGhlYXN0LTE6NTU3ODIyODM0MzA3OnNlY3JldDp0ZW5kZXJseS1hcGktd1FhSTJSJyxcbiAgICB9KVxuXG4gICAgY29uc3QgZXRoR2FzU3RhdGlvbkluZm9VcmwgPSBzbS5TZWNyZXQuZnJvbVNlY3JldEF0dHJpYnV0ZXModGhpcywgJ0VUSEdhc1N0YXRpb25VcmwnLCB7XG4gICAgICBzZWNyZXRDb21wbGV0ZUFybjogJ2Fybjphd3M6c2VjcmV0c21hbmFnZXI6YXAtc291dGhlYXN0LTE6NTU3ODIyODM0MzA3OnNlY3JldDpldGgtZ2FzLXN0YXRpb24taW5mby11cmwtdWxHbmNYJyxcbiAgICB9KVxuXG4gICAgY29uc3QgcGluYXRhQXBpID0gc20uU2VjcmV0LmZyb21TZWNyZXRBdHRyaWJ1dGVzKHRoaXMsICdQaW5hdGFBUEknLCB7XG4gICAgICBzZWNyZXRDb21wbGV0ZUFybjogJ2Fybjphd3M6c2VjcmV0c21hbmFnZXI6YXAtc291dGhlYXN0LTE6NTU3ODIyODM0MzA3OnNlY3JldDpwaW5hdGEtYXBpLWtleS1VVkxBZk0nLFxuICAgIH0pXG4gICAgY29uc3Qgcm91dGU1M0FybiA9IHNtLlNlY3JldC5mcm9tU2VjcmV0QXR0cmlidXRlcyh0aGlzLCAnUm91dGU1M0FybicsIHtcbiAgICAgIHNlY3JldENvbXBsZXRlQXJuOiAnYXJuOmF3czpzZWNyZXRzbWFuYWdlcjphcC1zb3V0aGVhc3QtMTo1NTc4MjI4MzQzMDc6c2VjcmV0OlJvdXRlNTNBcm4tZWxSbW13JyxcbiAgICB9KVxuXG4gICAgY29uc3QgcGluYXRhU2VjcmV0ID0gc20uU2VjcmV0LmZyb21TZWNyZXRBdHRyaWJ1dGVzKHRoaXMsICdQaW5hdGFTZWNyZXQnLCB7XG4gICAgICBzZWNyZXRDb21wbGV0ZUFybjogJ2Fybjphd3M6c2VjcmV0c21hbmFnZXI6YXAtc291dGhlYXN0LTE6NTU3ODIyODM0MzA3OnNlY3JldDpwaW5hdGEtc2VjcmV0LXN2R2FQdCcsXG4gICAgfSlcblxuICAgIGNvbnN0IGhvc3RlZFpvbmUgPSBzbS5TZWNyZXQuZnJvbVNlY3JldEF0dHJpYnV0ZXModGhpcywgJ0hvc3RlZFpvbmUnLCB7XG4gICAgICBzZWNyZXRDb21wbGV0ZUFybjogJ2Fybjphd3M6c2VjcmV0c21hbmFnZXI6YXAtc291dGhlYXN0LTE6NTU3ODIyODM0MzA3OnNlY3JldDpob3N0ZWQtem9uZS1KbVBETlYnLFxuICAgIH0pXG5cbiAgICAvLyBQYXJzZSBBV1MgU2VjcmV0XG4gICAgbGV0IGpzb25ScGNQcm92aWRlcnMgPSB7fSBhcyB7IFtjaGFpbklkOiBzdHJpbmddOiBzdHJpbmcgfVxuICAgIFNVUFBPUlRFRF9DSEFJTlMuZm9yRWFjaCgoY2hhaW5JZDogQ2hhaW5JZCkgPT4ge1xuICAgICAgLy8gVE9ETzogQ2hhbmdlIHRoaXMgdG8gYEpTT05fUlBDX1BST1ZJREVSXyR7fWAgdG8gYmUgY29uc2lzdGVudCB3aXRoIFNPUlxuICAgICAgY29uc3Qga2V5ID0gYFdFQjNfUlBDXyR7Y2hhaW5JZH1gXG4gICAgICBqc29uUnBjUHJvdmlkZXJzW2tleV0gPSBqc29uUnBjUHJvdmlkZXJzU2VjcmV0LnNlY3JldFZhbHVlRnJvbUpzb24oa2V5KS50b1N0cmluZygpXG4gICAgfSlcblxuICAgIC8vIEJldGEgYXAtc291dGhlYXN0LTFcbiAgICBjb25zdCBiZXRhVXNFYXN0MlN0YWdlID0gbmV3IFJvdXRpbmdBUElTdGFnZSh0aGlzLCAnYmV0YS1hcC1zb3V0aGVhc3QtMScsIHtcbiAgICAgIGVudjogeyBhY2NvdW50OiAnNTU3ODIyODM0MzA3JywgcmVnaW9uOiAnYXAtc291dGhlYXN0LTEnIH0sXG4gICAgICBqc29uUnBjUHJvdmlkZXJzOiBqc29uUnBjUHJvdmlkZXJzLFxuICAgICAgcHJvdmlzaW9uZWRDb25jdXJyZW5jeTogMTAwLFxuICAgICAgZXRoR2FzU3RhdGlvbkluZm9Vcmw6IGV0aEdhc1N0YXRpb25JbmZvVXJsLnNlY3JldFZhbHVlLnRvU3RyaW5nKCksXG4gICAgICBzdGFnZTogU1RBR0UuQkVUQSxcbiAgICAgIHJvdXRlNTNBcm46IHJvdXRlNTNBcm4uc2VjcmV0VmFsdWVGcm9tSnNvbignYXJuJykudG9TdHJpbmcoKSxcbiAgICAgIHBpbmF0YV9rZXk6IHBpbmF0YUFwaS5zZWNyZXRWYWx1ZUZyb21Kc29uKCdwaW5hdGEtYXBpLWtleScpLnRvU3RyaW5nKCksXG4gICAgICBwaW5hdGFfc2VjcmV0OiBwaW5hdGFTZWNyZXQuc2VjcmV0VmFsdWVGcm9tSnNvbignc2VjcmV0JykudG9TdHJpbmcoKSxcbiAgICAgIGhvc3RlZF96b25lOiBob3N0ZWRab25lLnNlY3JldFZhbHVlRnJvbUpzb24oJ3pvbmUnKS50b1N0cmluZygpLFxuICAgICAgdGVuZGVybHlVc2VyOiB0ZW5kZXJseUNyZWRzLnNlY3JldFZhbHVlRnJvbUpzb24oJ3RlbmRlcmx5LXVzZXInKS50b1N0cmluZygpLFxuICAgICAgdGVuZGVybHlQcm9qZWN0OiB0ZW5kZXJseUNyZWRzLnNlY3JldFZhbHVlRnJvbUpzb24oJ3RlbmRlcmx5LXByb2plY3QnKS50b1N0cmluZygpLFxuICAgICAgdGVuZGVybHlBY2Nlc3NLZXk6IHRlbmRlcmx5Q3JlZHMuc2VjcmV0VmFsdWVGcm9tSnNvbigndGVuZGVybHktYWNjZXNzLWtleScpLnRvU3RyaW5nKCksXG4gICAgfSlcblxuICAgIGNvbnN0IGJldGFVc0Vhc3QyQXBwU3RhZ2UgPSBwaXBlbGluZS5hZGRTdGFnZShiZXRhVXNFYXN0MlN0YWdlKVxuXG4gICAgdGhpcy5hZGRJbnRlZ1Rlc3RzKGNvZGUsIGJldGFVc0Vhc3QyU3RhZ2UsIGJldGFVc0Vhc3QyQXBwU3RhZ2UpXG5cbiAgICAvLyBQcm9kIGFwLXNvdXRoZWFzdC0xXG4gICAgY29uc3QgcHJvZFVzRWFzdDJTdGFnZSA9IG5ldyBSb3V0aW5nQVBJU3RhZ2UodGhpcywgJ3Byb2QtYXAtc291dGhlYXN0LTEnLCB7XG4gICAgICBlbnY6IHsgYWNjb3VudDogJzU1NzgyMjgzNDMwNycsIHJlZ2lvbjogJ2FwLXNvdXRoZWFzdC0xJyB9LFxuICAgICAganNvblJwY1Byb3ZpZGVyczoganNvblJwY1Byb3ZpZGVycyxcbiAgICAgIHByb3Zpc2lvbmVkQ29uY3VycmVuY3k6IDEwMCxcbiAgICAgIGV0aEdhc1N0YXRpb25JbmZvVXJsOiBldGhHYXNTdGF0aW9uSW5mb1VybC5zZWNyZXRWYWx1ZS50b1N0cmluZygpLFxuICAgICAgY2hhdGJvdFNOU0FybjogJ2Fybjphd3M6c25zOmFwLXNvdXRoZWFzdC0xOjU1NzgyMjgzNDMwNzpTbGFja0NoYXRib3RUb3BpYycsXG4gICAgICBzdGFnZTogU1RBR0UuUFJPRCxcbiAgICAgIHJvdXRlNTNBcm46IHJvdXRlNTNBcm4uc2VjcmV0VmFsdWVGcm9tSnNvbignYXJuJykudG9TdHJpbmcoKSxcbiAgICAgIHBpbmF0YV9rZXk6IHBpbmF0YUFwaS5zZWNyZXRWYWx1ZUZyb21Kc29uKCdwaW5hdGEtYXBpLWtleScpLnRvU3RyaW5nKCksXG4gICAgICBwaW5hdGFfc2VjcmV0OiBwaW5hdGFTZWNyZXQuc2VjcmV0VmFsdWVGcm9tSnNvbignc2VjcmV0JykudG9TdHJpbmcoKSxcbiAgICAgIGhvc3RlZF96b25lOiBob3N0ZWRab25lLnNlY3JldFZhbHVlRnJvbUpzb24oJ3pvbmUnKS50b1N0cmluZygpLFxuICAgICAgdGVuZGVybHlVc2VyOiB0ZW5kZXJseUNyZWRzLnNlY3JldFZhbHVlRnJvbUpzb24oJ3RlbmRlcmx5LXVzZXInKS50b1N0cmluZygpLFxuICAgICAgdGVuZGVybHlQcm9qZWN0OiB0ZW5kZXJseUNyZWRzLnNlY3JldFZhbHVlRnJvbUpzb24oJ3RlbmRlcmx5LXByb2plY3QnKS50b1N0cmluZygpLFxuICAgICAgdGVuZGVybHlBY2Nlc3NLZXk6IHRlbmRlcmx5Q3JlZHMuc2VjcmV0VmFsdWVGcm9tSnNvbigndGVuZGVybHktYWNjZXNzLWtleScpLnRvU3RyaW5nKCksXG4gICAgfSlcblxuICAgIGNvbnN0IHByb2RVc0Vhc3QyQXBwU3RhZ2UgPSBwaXBlbGluZS5hZGRTdGFnZShwcm9kVXNFYXN0MlN0YWdlKVxuXG4gICAgdGhpcy5hZGRJbnRlZ1Rlc3RzKGNvZGUsIHByb2RVc0Vhc3QyU3RhZ2UsIHByb2RVc0Vhc3QyQXBwU3RhZ2UpXG5cbiAgICBjb25zdCBzbGFja0NoYW5uZWwgPSBjaGF0Ym90LlNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb24uZnJvbVNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb25Bcm4oXG4gICAgICB0aGlzLFxuICAgICAgJ1NsYWNrQ2hhbm5lbCcsXG4gICAgICAnYXJuOmF3czpjaGF0Ym90Ojo1NTc4MjI4MzQzMDc6Y2hhdC1jb25maWd1cmF0aW9uL3NsYWNrLWNoYW5uZWwvZW5nLW9wcy1zbGFjay1jaGF0Ym90J1xuICAgIClcblxuICAgIHBpcGVsaW5lLmJ1aWxkUGlwZWxpbmUoKVxuICAgIHBpcGVsaW5lLnBpcGVsaW5lLm5vdGlmeU9uKCdOb3RpZnlTbGFjaycsIHNsYWNrQ2hhbm5lbCwge1xuICAgICAgZXZlbnRzOiBbUGlwZWxpbmVOb3RpZmljYXRpb25FdmVudHMuUElQRUxJTkVfRVhFQ1VUSU9OX0ZBSUxFRF0sXG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgYWRkSW50ZWdUZXN0cyhcbiAgICBzb3VyY2VBcnRpZmFjdDogY2RrLnBpcGVsaW5lcy5Db2RlUGlwZWxpbmVTb3VyY2UsXG4gICAgcm91dGluZ0FQSVN0YWdlOiBSb3V0aW5nQVBJU3RhZ2UsXG4gICAgYXBwbGljYXRpb25TdGFnZTogY2RrLnBpcGVsaW5lcy5TdGFnZURlcGxveW1lbnRcbiAgKSB7XG4gICAgY29uc3QgdGVzdEFjdGlvbiA9IG5ldyBDb2RlQnVpbGRTdGVwKGBJbnRlZ1Rlc3RzLSR7cm91dGluZ0FQSVN0YWdlLnN0YWdlTmFtZX1gLCB7XG4gICAgICBwcm9qZWN0TmFtZTogYEludGVnVGVzdHMtJHtyb3V0aW5nQVBJU3RhZ2Uuc3RhZ2VOYW1lfWAsXG4gICAgICBpbnB1dDogc291cmNlQXJ0aWZhY3QsXG4gICAgICBlbnZGcm9tQ2ZuT3V0cHV0czoge1xuICAgICAgICBVTklTV0FQX1JPVVRJTkdfQVBJOiByb3V0aW5nQVBJU3RhZ2UudXJsLFxuICAgICAgfSxcbiAgICAgIGJ1aWxkRW52aXJvbm1lbnQ6IHtcbiAgICAgICAgZW52aXJvbm1lbnRWYXJpYWJsZXM6IHtcbiAgICAgICAgICBOUE1fVE9LRU46IHtcbiAgICAgICAgICAgIHZhbHVlOiAnbnBtLXByaXZhdGUtcmVwby1hY2Nlc3MtdG9rZW4nLFxuICAgICAgICAgICAgdHlwZTogQnVpbGRFbnZpcm9ubWVudFZhcmlhYmxlVHlwZS5TRUNSRVRTX01BTkFHRVIsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBBUkNISVZFX05PREVfUlBDOiB7XG4gICAgICAgICAgICB2YWx1ZTogJ2FyY2hpdmUtbm9kZS1ycGMtdXJsLWRlZmF1bHQta21zJyxcbiAgICAgICAgICAgIHR5cGU6IEJ1aWxkRW52aXJvbm1lbnRWYXJpYWJsZVR5cGUuU0VDUkVUU19NQU5BR0VSLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgY29tbWFuZHM6IFtcbiAgICAgICAgJ2VjaG8gXCIvL3JlZ2lzdHJ5Lm5wbWpzLm9yZy86X2F1dGhUb2tlbj0ke05QTV9UT0tFTn1cIiA+IC5ucG1yYyAmJiBucG0gY2knLFxuICAgICAgICAnZWNobyBcIlVOSVNXQVBfUk9VVElOR19BUEk9JHtVTklTV0FQX1JPVVRJTkdfQVBJfVwiID4gLmVudicsXG4gICAgICAgICdlY2hvIFwiQVJDSElWRV9OT0RFX1JQQz0ke0FSQ0hJVkVfTk9ERV9SUEN9XCIgPj4gLmVudicsXG4gICAgICAgICducG0gaW5zdGFsbCcsXG4gICAgICAgICducG0gcnVuIGJ1aWxkJyxcbiAgICAgICAgJ25wbSBydW4gaW50ZWctdGVzdCcsXG4gICAgICBdLFxuICAgIH0pXG5cbiAgICBhcHBsaWNhdGlvblN0YWdlLmFkZFBvc3QodGVzdEFjdGlvbilcbiAgfVxufVxuXG5jb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpXG5cbmNvbnN0IGpzb25ScGNQcm92aWRlcnMgPSB7XG4gIFdFQjNfUlBDXzE6IHByb2Nlc3MuZW52LkpTT05fUlBDX1BST1ZJREVSXzEhLFxuICBXRUIzX1JQQ18zOiBwcm9jZXNzLmVudi5KU09OX1JQQ19QUk9WSURFUl8zISxcbiAgV0VCM19SUENfNDogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfNCEsXG4gIFdFQjNfUlBDXzU6IHByb2Nlc3MuZW52LkpTT05fUlBDX1BST1ZJREVSXzUhLFxuICBXRUIzX1JQQ180MjogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfNDIhLFxuICBXRUIzX1JQQ18xMDogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfMTAhLFxuICBXRUIzX1JQQ182OTogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfNjkhLFxuICBXRUIzX1JQQ180MjE2MTogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfNDIxNjEhLFxuICBXRUIzX1JQQ180MjE2MTE6IHByb2Nlc3MuZW52LkpTT05fUlBDX1BST1ZJREVSXzQyMTYxMSEsXG4gIFdFQjNfUlBDXzQyMTYxMzogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfNDIxNjEzISxcbiAgV0VCM19SUENfMTM3OiBwcm9jZXNzLmVudi5KU09OX1JQQ19QUk9WSURFUl8xMzchLFxuICBXRUIzX1JQQ184MDAwMTogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfODAwMDEhLFxuICBXRUIzX1JQQ180MjIyMDogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfNDIyMjAhLFxuICBXRUIzX1JQQ180NDc4NzogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfNDQ3ODchLFxuICBXRUIzX1JQQ181NjogcHJvY2Vzcy5lbnYuSlNPTl9SUENfUFJPVklERVJfNTYhLFxufVxuXG4vLyBMb2NhbCBkZXYgc3RhY2tcbm5ldyBSb3V0aW5nQVBJU3RhY2soYXBwLCAnUm91dGluZ0FQSVN0YWNrJywge1xuICBqc29uUnBjUHJvdmlkZXJzOiBqc29uUnBjUHJvdmlkZXJzLFxuICBwcm92aXNpb25lZENvbmN1cnJlbmN5OiBwcm9jZXNzLmVudi5QUk9WSVNJT05fQ09OQ1VSUkVOQ1kgPyBwYXJzZUludChwcm9jZXNzLmVudi5QUk9WSVNJT05fQ09OQ1VSUkVOQ1kpIDogMCxcbiAgdGhyb3R0bGluZ092ZXJyaWRlOiBwcm9jZXNzLmVudi5USFJPVFRMRV9QRVJfRklWRV9NSU5TLFxuICBldGhHYXNTdGF0aW9uSW5mb1VybDogcHJvY2Vzcy5lbnYuRVRIX0dBU19TVEFUSU9OX0lORk9fVVJMISxcbiAgY2hhdGJvdFNOU0FybjogcHJvY2Vzcy5lbnYuQ0hBVEJPVF9TTlNfQVJOLFxuICBzdGFnZTogU1RBR0UuTE9DQUwsXG4gIHJvdXRlNTNBcm46IHByb2Nlc3MuZW52LlJPTEVfQVJOLFxuICBwaW5hdGFfa2V5OiBwcm9jZXNzLmVudi5QSU5BVEFfQVBJX0tFWSEsXG4gIHBpbmF0YV9zZWNyZXQ6IHByb2Nlc3MuZW52LlBJTkFUQV9BUElfU0VDUkVUISxcbiAgaG9zdGVkX3pvbmU6IHByb2Nlc3MuZW52LkhPU1RFRF9aT05FISxcbiAgdGVuZGVybHlVc2VyOiBwcm9jZXNzLmVudi5URU5ERVJMWV9VU0VSISxcbiAgdGVuZGVybHlQcm9qZWN0OiBwcm9jZXNzLmVudi5URU5ERVJMWV9QUk9KRUNUISxcbiAgdGVuZGVybHlBY2Nlc3NLZXk6IHByb2Nlc3MuZW52LlRFTkRFUkxZX0FDQ0VTU19LRVkhLFxufSlcblxubmV3IFJvdXRpbmdBUElQaXBlbGluZShhcHAsICdSb3V0aW5nQVBJUGlwZWxpbmVTdGFjaycsIHtcbiAgZW52OiB7IGFjY291bnQ6ICc1NTc4MjI4MzQzMDcnLCByZWdpb246ICdhcC1zb3V0aGVhc3QtMScgfSxcbn0pXG4iXX0=